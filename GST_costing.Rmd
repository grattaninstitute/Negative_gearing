---
title: "GST expenditure by age and income, for categories"
author: "Hugh Parsonage"
output: 
  html_document:
    css: floatToc.css
    toc: true
    toc_depth: 3
    theme: united
---

# What are the consumption patterns of different income quintiles?
This `Rmd` file attempts to determine the distributional impact of broadening the GST to include currently exempt food, education, health, and childcare. We use the ABS's Household Expenditure Survey 2009-10, being the most recent survey containing this information. 

Some issues:

+ No behaviour change. We assume there will be no change (*i.e.* no reduction) in consumption of items currently GST exempt.
+ Health expenditure is dubious. Highly volatile spending. 
+ Fresh food is available for each quintile. We assume the relationship between spending on GST-exempt food and income is linear and does not change across age groups. 
+ Education spending not availble except aggregated by household income and household age head of household. We assume that the relationship between spending and income is the same across each age group. 
+ Education and childcare spending only available by quintile. We assume that half the total spending in a quintile goes to each decile.

```{r, results='hide'}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      cache=TRUE,
                      fig.height=8, fig.width=10)
```

```{r, cache=FALSE}
library(ggplot2)
library(grattan)
library(VIM) # VIM::hotdeck used for imputation
library(dplyr)
library(foreign)
library(survey)
library(data.table)
library(readxl)
library(readr)
library(tidyr)
library(magrittr)
library(httr)

weighted.var.se <- function(x, w, na.rm=FALSE){
  # Computes the variance of a weighted mean following Cochran 1977 definition
  # http://stats.stackexchange.com/questions/25895/computing-standard-error-in-weighted-mean-estimation
  if (na.rm) { w <- w[i <- !is.na(x)]; x <- x[i] }
  n = length(w)
  xWbar = weighted.mean(x,w,na.rm=na.rm)
  wbar = mean(w)
  out = n/((n-1)*sum(w)^2)*(sum((w*x-wbar*xWbar)^2)-2*xWbar*sum((w-wbar)*(w*x-wbar*xWbar))+xWbar^2*sum((w-wbar)^2))
  return(out)
}

age_mutate <- function(.hes){
  .hes %>%
    mutate(
      age_group = as.character(Age_of_HH_reference_person),
      age_group = ifelse(grepl("^[0-9]+$", age_group), 
                         ifelse(as.numeric(age_group) < 20,
                                "20 or under",
                                paste((as.numeric(age_group) %/% 5) * 5,
                                      "to",
                                      (as.numeric(age_group) %/% 5) * 5 + 4)),
                         age_group
      )
    )
}

group_by.income_quintile <- function(.data, type = "Current_weekly_HH_disposable_income"){
  if(type == "Current_weekly_HH_disposable_income"){
    group_by(.data, income_quintile = factor(as.numeric(cut(Current_weekly_HH_disposable_income, 
                                                            breaks = total.inc.quintiles, 
                                                            include.lowest = TRUE)))) 
  }
}

# Taxation statistics 2012-13 Goods and services tax: Selected GST, WET and LCT items, 2001-02 to 2013-14 financial years
if(!file.exists("GST_by_year.xlsx")){
  GST_url <- "http://data.gov.au/dataset/e29ef9ca-0d1a-47ec-9e9b-14a79a941511/resource/0e56ca39-832e-40ca-bc62-297a3fb552cf/download/taxstats2013gst1gstwetlctmultiyear.xlsx"
  GET(GST_url, write_disk("GST_by_year.xlsx"))
}
GST_inflator_from0910_to1314 <-
  read_excel("GST_by_year.xlsx", sheet = "GST Table 1", skip = 2) %>%
  setnames(1:2, c("Selected_item", "unit")) %>% 
  # en dash caution
  setnames(old = names(.), new = gsub("([0-9]{4}).([0-9]{2})", "\\1-\\2", names(.))) %>%
  gather(year, value, `2001-02`:`2013-14`) %>%
  mutate(value = as.numeric(value)) %>%
  filter(complete.cases(.)) %>%
  filter(grepl("Net.GST", Selected_item)) %>%
  filter(grepl("^((2009)|(2013))", year)) %$%
  {last(value) / first(value)}
```
Our first task is to make the HES variables meaningful. Do you know what `INCTOPH8` means? Let's find out! The way I did that was to link the variables in the variable listings excel file to the definition therein. We also have to make the variables suitable for R, *viz* no spaces or weird characters.
```{r}
hes10hh_raw <- read.dta("./HES/hes10bh.dta")

hes.sih.vars <- read_excel("./SIH/HES_and_SIH_variable_listing.xlsx") 

# See page 21 of HES 2009-10 user guide
# http://www.ausstats.abs.gov.au/ausstats/subscriber.nsf/0/1D03ACBBD40275ADCA257A3900173E85/$File/65030_1.pdf
hes.sih.vars %<>%
  mutate(Definition = ifelse(HES_basic_name == "COICEXP", paste0(Definition, "_COICOP"), Definition))

hes.sih.vars %<>%
  gather(GROUP, variable, -Definition) %>%
  mutate(variable = gsub("[^A-Za-z0-9]", "", variable)) %>%
  filter(complete.cases(.)) %>%
  spread(GROUP, variable) %>%
  mutate(
    # replace all nonletters with _ unless they occur at the end of the name,
    # in which case delete it
    Definition_new = gsub("[^A-Za-z]+(?!$)", "_", Definition, perl = TRUE),
    Definition_new = gsub("[^A-Za-z]+$", "", Definition_new)
  )
```

```{r}
hes10hh.names <- 
  hes.sih.vars$HES_basic_name[hes.sih.vars$HES_basic_name %in% names(hes10hh_raw)]
hes10hh.newnames <-
  hes.sih.vars$Definition_new[hes.sih.vars$HES_basic_name %in% names(hes10hh_raw)]

hes10hh <-
  hes10hh_raw %>%
  # This omits some weights and PETTAX (hh consumption of fuel tax) for some reason
  select_(.dots = hes10hh.names) %>%
  data.table %>%
  setnames(old = hes10hh.names, 
           new = hes10hh.newnames)
```
We now have an object, `hes10hh`, with meaningful column names. I prefer the following values for our ages:
```{r}
# Age cleaning
hes10hh %<>%
  mutate(
    Age_of_HH_reference_person = factor(gsub(" years",
                                             "",
                                             Age_of_HH_reference_person))
  ) 
```
## Calculation of quantiles.
We will only use the quintiles and deciles.
```{r}
disp.inc.percentiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Current_weekly_HH_disposable_income # disposable income
              ,.
              ,quantiles = c(0:100)/100)
disp.inc.deciles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Current_weekly_HH_disposable_income 
              ,.
              , quantiles = c(0:10)/10)

total.inc.percentiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Total_current_weekly_HH_income_from_all_sources 
              ,.
              , quantiles = c(0:100)/100)

total.inc.deciles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Total_current_weekly_HH_income_from_all_sources 
              ,.
              , quantiles = c(0:10)/10)

total.inc.quintiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Total_current_weekly_HH_income_from_all_sources 
              ,.
              #, quantiles = c(0:5)/5)
              ,quantiles = c(0:5)/5)


hes10hh %<>%
  mutate(income.percentile = factor(as.numeric(cut(Current_weekly_HH_employee_income, 
                                                   breaks = disp.inc.percentiles, 
                                                   include.lowest = TRUE)))) 
```


```{r}
hes10hh %>%
  group_by(income.percentile) %>%
  summarise(mean = weighted.mean(Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, w = Weight_HH_HES),
            se = sqrt(weighted.var.se(Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, w = Weight_HH_HES))) %>%
  arrange(income.percentile) 

food_by_age <- 
  hes10hh %>%
  mutate(
    age_group = as.character(Age_of_HH_reference_person),
    age_group = ifelse(grepl("^[0-9]+$", age_group), 
                       ifelse(as.numeric(age_group) < 20,
                              "20 or under",
                              paste((as.numeric(age_group) %/% 5) * 5,
                                    "to",
                                    (as.numeric(age_group) %/% 5) * 5 + 4)),
                       age_group
    )
  ) %>% 
  mutate(total.inc.deciles = factor(as.numeric(cut(Current_weekly_HH_employee_income, 
                                                   breaks = total.inc.deciles, 
                                                   include.lowest = TRUE)))) %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyby(~Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, ~total.inc.deciles + age_group, ., svymean,
        keep.names = FALSE) %>%
  setnames(c("Total_income_decile", 
             "age_group",
             "Food_exp.avg",
             "se")) %>%
  # cosmetic
  setattr(c("call", "svyby"), c(NULL, NULL)) %>%
  mutate(Total_income_decile = as.integer(as.character(Total_income_decile)))


```

## Individuals

```{r}
hes10_indiv_raw <- 
  read.dta("./HES/hes10bp.dta")

hes10hp.names <- 
  hes.sih.vars$HES_basic_name[hes.sih.vars$HES_basic_name %in% names(hes10_indiv_raw)]
hes10hp.newnames <-
  hes.sih.vars$Definition_new[hes.sih.vars$HES_basic_name %in% names(hes10_indiv_raw)]

hes10_indiv <- 
  hes10_indiv_raw %>%
  data.table %>%
  select_(.dots = hes10hp.names) %>%
  setnames(old = hes10hp.names, 
           new = hes10hp.newnames)

total.inc.deciles_indiv <- 
  hes10_indiv_raw %>%
  svydesign(~ABSPID, data = ., weights = ~HESPSWT) %>%
  svyquantile(~INCTSCP8 # total weekly income from all sources
              ,.
              , quantiles = c(0:10)/10)

total.inc.quintiles_indiv <- 
  hes10_indiv_raw %>%
  svydesign(~ABSPID, data = ., weights = ~HESPSWT) %>%
  svyquantile(~INCTSCP8 # total weekly income from all sources
              ,.
              , quantiles = c(0:5)/5)

# hes10_indiv %>%
#   mutate(tot.inc.deciles = factor(as.numeric(cut(Total_current_weekly_income_from_all_sources, 
#                                                   breaks = total.inc.deciles_indiv, 
#                                                   include.lowest = TRUE)))) %>%
#   svydesign(~Person_number_within_each_income_unit, data = ., weights = ~Weight_Person_HES) %>%
#   svyby(~Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, 
#         by = ~tot.inc.deciles + Age_of_person,
#         svymean)

```

```{r}
HH_GST_expenditure_by_quintile <- 
  read_excel("HH_GST_expenditure_by_quintile.xlsx", sheet = "GST_by_quintile") %>% 
  gather(Quintile, weekly_expenditure, Q1:Q5) %>%
  filter(!grepl("[12]$", Category)) 
```

```{r}
HH_food_expenditure_by_decile.age <- 
  hes10hh %>%
  mutate(
    age_group = as.character(Age_of_HH_reference_person),
    age_group = ifelse(grepl("^[0-9]+$", age_group), 
                       ifelse(as.numeric(age_group) < 20,
                              "20 or under",
                              paste((as.numeric(age_group) %/% 5) * 5,
                                    "to",
                                    (as.numeric(age_group) %/% 5) * 5 + 4)),
                       age_group
    )
  ) %>% 
  mutate(Total_income_decile = factor(as.numeric(cut(Current_weekly_HH_disposable_income, 
                                                   breaks = total.inc.deciles, 
                                                   include.lowest = TRUE)))) 
```

## Determining the GST expenditure for each category, for each age and income decile
### Household quintiles
```{r}
HH_GST_expenditure_by_quintile %<>%
  mutate(
    quantile = as.numeric(gsub("Q", "", Quintile)),
    quantile = (quantile / 5) - 0.1 - (quantile < 3) * 0.05 + (quantile > 3) * 0.05,
    Quintile = as.integer(gsub("Q", "", Quintile))
  ) 
```

```{r}
food_and_income.gst <- 
  hes10hh %>% 
  mutate(total.inc.quintiles = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                     breaks = total.inc.quintiles,  # Total current weekly HH income from all sources
                                                     include.lowest = TRUE)))) %>% 
  group_by(total.inc.quintiles) %>% 
  summarise(
    average_food = weighted.mean(Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, 
                                 w = Weight_HH_HES)) %>% 
  data.frame %>% 
  merge(filter(HH_GST_expenditure_by_quintile, Category == "Food"), by.x = "total.inc.quintiles", by.y = "Quintile") %>% 
  setnames("weekly_expenditure", "weekly_exp_GST_liable_food") %>%
  mutate(prop = weekly_exp_GST_liable_food/average_food) %>%
  merge(data.frame(quantile = (0:20)/20), all.y = TRUE, all.x = TRUE) %>%
  do(data.frame(., pred_prop_GST = predict(lm(prop ~ quantile, data = .), newdata=.))) %>%
  select(quantile, pred_prop_GST) %>%
  # BEWARE FLOATING POINT ARITHMETIC
  dplyr::filter(quantile %in% c(0.05, 0.15, 0.25, 0.35, 0.45, 0.55, 0.65, 0.75, 0.85, 0.95)) %>%
  mutate(Total_income_decile = as.integer(factor(quantile)))
```
### Food consumption by age
```{r}
chessboard <- 
  data.table::CJ(
    unique(HH_food_expenditure_by_decile.age$age_group),
    1:10
  ) %>%
  setnames(old = paste0("V", 1:2), new = c("age_group", "Total_income_decile"))

food_by_age_income <- 
  HH_food_expenditure_by_decile.age %>%
  merge(chessboard, by = c("age_group", "Total_income_decile"), all.y = TRUE) %>%
  ## HOT DECK 
  VIM::hotdeck(., variable = "Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only") %>%
  VIM::hotdeck(., variable = "Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only") %>%
  # this is to ensure smooth execution of code with following design objects
  mutate(Unique_household_number = ifelse(is.na(Unique_household_number), 
                                          paste0(lag(Unique_household_number), "x"),
                                          Unique_household_number),
         Weight_HH_HES = ifelse(is.na(Weight_HH_HES),
                                max(Weight_HH_HES, na.rm = TRUE),
                                Weight_HH_HES)) %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyby(~Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, ~Total_income_decile + age_group, ., svymean, keep.names = FALSE) %>%
  setnames(c("Total_income_decile", 
             "age_group",
             "Food_exp.avg",
             "se")) %>%
  setattr(c("call", "svyby"), c(NULL, NULL)) %>%
  mutate(Total_income_decile = as.integer(as.character(Total_income_decile))) %>%
  merge(food_and_income.gst, by = "Total_income_decile") %>%
  mutate(Food_GST = Food_exp.avg * pred_prop_GST) %>%
  mutate(age_group_text = gsub("\\s+", "\n", age_group))

food_by_age_income %>%
  grplot(aes(x = age_group_text, y = factor(Total_income_decile), alpha = Food_GST)) + 
  geom_tile(fill = Orange) + 
  geom_point(data = filter(food_by_age_income, 1.96 * se > Food_GST | se == 0),
             aes(size = se/Food_GST,
                 shape = se == 0),
             color = "red", alpha= 1) + 
  scale_alpha_continuous(label=grattan_dollar) + 
  xlab("Age group") + 
  scale_shape_manual(values = c(23, 24)) +
  coord_equal() + 
  theme_grattan(base_size = 18) +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "right")
```

## Health
```{r}
health_by_age_income <-
  hes10hh %>%
  mutate(
    age_group = as.character(Age_of_HH_reference_person),
    age_group = ifelse(grepl("^[0-9]+$", age_group), 
                       ifelse(as.numeric(age_group) < 20,
                              "20 or under",
                              paste((as.numeric(age_group) %/% 5) * 5,
                                    "to",
                                    (as.numeric(age_group) %/% 5) * 5 + 4)),
                       age_group
    )
  ) %>% 
  mutate(Total_income_decile = factor(as.numeric(cut(Current_weekly_HH_disposable_income, 
                                                   breaks = total.inc.deciles, 
                                                   include.lowest = TRUE)))) %>%
  merge(chessboard, by = c("age_group", "Total_income_decile"), all.y = TRUE) %>%
  ## HOT DECK 
  VIM::hotdeck(., variable = "Household_weekly_expenditure_on_medical_care_and_health_expenses_HES_only") %>%
  mutate(Unique_household_number = ifelse(is.na(Unique_household_number), 
                                          paste0(lag(Unique_household_number), "x"),
                                          Unique_household_number),
         Weight_HH_HES = ifelse(is.na(Weight_HH_HES),
                                max(Weight_HH_HES, na.rm = TRUE),
                                Weight_HH_HES)) %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyby(~Household_weekly_expenditure_on_medical_care_and_health_expenses_HES_only, ~Total_income_decile + age_group, ., svymean) %>%  
  setnames(c("Total_income_decile", 
             "age_group",
             "Health_exp.avg",
             "se")) %>%
  setattr(c("call", "svyby"), c(NULL, NULL)) %>%
  mutate(Total_income_decile = as.integer(as.character(Total_income_decile))) %>%
  mutate(age_group_text = gsub("\\s+", "\n", age_group)) 

grplot(data = health_by_age_income,
       aes(x = age_group_text,
           y = Total_income_decile, 
           alpha = Health_exp.avg)) + 
  geom_tile(fill = Orange) + 
  # se == 0 is also suspicious: it suggests there was only one observation in that group.
  geom_point(data = filter(health_by_age_income, 1.96 * se > Health_exp.avg | se == 0),
             aes(size = se/Health_exp.avg,
                 shape = se == 0),
             color = "red", alpha= 1) + 
  xlab("Age group") + 
  scale_shape_manual(values = c(23, 24)) +
  scale_alpha_continuous(label=grattan_dollar) +
  coord_equal() + 
  theme_grattan(base_size = 18) +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "right")
```

# Expand quintiles to deciles
## Split the difference

## Education
```{r}
education_by_incomeQ <- 
  read_excel("Education_HES10_detailed.xlsx", sheet = "Education_by_income") %>%
  filter(as.logical(Total)) %>% select(-Total, -Subgroup) %>%
  gather(Quintile, amount, Q1:Q5) %>%
  mutate(amount = as.numeric(gsub("*", "", amount, fixed = TRUE))) %>%
  mutate(Quintile = as.integer(gsub("Q", "", Quintile))) %>%
  group_by(Quintile) %>%
  summarise(education.exp.Q = sum(amount)) %>%
  ungroup %>%
  mutate(education.exp.prop.Q = education.exp.Q / sum(education.exp.Q)) %>%
  data.table %>%
  setkey(Quintile)

education_by_age.names <- 
  read_excel("Education_HES10_detailed.xlsx", sheet = "Education_by_age") %>%
  names

education_by_age <- 
  read_excel("Education_HES10_detailed.xlsx", sheet = "Education_by_age") %>%
  gather_("age_group", "amount", grep("^[1-9]", education_by_age.names, value = TRUE)) %>%
  filter(as.logical(Total)) %>% select(-Total, -Subgroup) %>%
  mutate(amount = as.numeric(gsub("*", "", amount, fixed = TRUE))) %>%
  group_by(age_group) %>%
  summarise(education.exp.age = sum(amount)) %>%
  ungroup %>%
  mutate(education.exp.prop.age = education.exp.age / sum(education.exp.age)) %>%
  data.table %>% 
  setkey(age_group)

# Assume that every age has the same distribution of education expenses by income
education_by_age_income <-
data.table::CJ(
  Quintile = c(1:5, (1:5-0.5)),
  age_group = education_by_age$age_group
) %>%
  merge(., education_by_age, by = "age_group") %>%
  setkey(Quintile) %>%
  merge(., education_by_incomeQ) %>%
  mutate(est.education.spend = education.exp.age * education.exp.prop.Q) %>%
  right_join(.,
    data.table(Quintile = rep(1:5, each = 2),
               Decile = 1:10)
  ) %>%
  mutate(
    education.exp.est_decile = est.education.spend / 2
  )
```

# Childcare
```{r}
childcare_by_age <- 
  read_excel("EducationChildcare_HES10_detailed.xlsx", sheet = "Childcare_by_age") %>%
  gather(age_group, child_care.expAge, -Group) %>%
  data.table

childcare_by_income <-
  read_excel("EducationChildcare_HES10_detailed.xlsx", sheet = "Childcare_by_income") %>%
  gather(Quintile, child_care.expQ, -Group) %>%
  mutate(Quintile = as.integer(factor(Quintile))) %>%
  filter(complete.cases(.)) %>%
  mutate(child_care.expQ.prop = child_care.expQ/sum(child_care.expQ)) %>%
  data.table

childcare_by_age_income <- 
  data.table::CJ(
    Quintile = 1:5,
    age_group = childcare_by_age$age_group
  ) %>%
  setkey(Quintile) %>%
  merge(., childcare_by_income) %>%
  setkey(age_group) %>%
  merge(., childcare_by_age) %>%
  mutate(child_care.exp.est = child_care.expAge * child_care.expQ.prop) %>%
  select(age_group, Quintile, child_care.exp.est) %>%
  right_join(.,
    data.table(Quintile = rep(1:5, each = 2),
               Decile = 1:10)
  ) %>%
  mutate(
    child_care.exp.est_decile = child_care.exp.est / 2
  ) 
```

# All together now
```{r}
age_group_tbl <- 
  fread("age_table.csv")

food_by_age_income %<>%
  select(Total_income_decile, age_group, Food_GST) %>%
  # Check that this is indeed the right variable
  setnames("Food_GST", "est.expenditure") %>%
  mutate(Group = "Food")

health_by_age_income %<>%
  select(Total_income_decile, age_group, Health_exp.avg) %>%
  setnames("Health_exp.avg", "est.expenditure") %>%
  mutate(Group = "Health")

education_by_age_income %<>%
  select(Decile, age_group, est.education.spend) %>%
  # Note that this is not strictly true: it's household income.
  setnames(c("Decile", "est.education.spend"), 
           c("Total_income_decile", "est.expenditure")) %>%
  merge(., age_group_tbl, by.x = "age_group", by.y = "big_age") %>%
  group_by(Total_income_decile, little_age) %>%
  # assign equally among each subage
  mutate(n = n()) %>%
  mutate(est.expenditure = est.expenditure / n) %>%
  mutate(Group = "Education")  %>%
  setnames("little_age", "age_group")

childcare_by_age_income %<>%
  select(Decile, age_group, child_care.exp.est_decile) %>%
  setnames(c("Decile", "child_care.exp.est_decile"), 
           c("Total_income_decile", "est.expenditure")) %>%
  merge(., age_group_tbl, by.x = "age_group", by.y = "big_age") %>%
  group_by(Total_income_decile, little_age) %>%
  # assign equally among each subage
  mutate(n = n()) %>%
  mutate(est.expenditure = est.expenditure / n) %>%
  mutate(Group = "Childcare") %>%
  setnames("little_age", "age_group")

GST_by_age_and_income <- 
bind_rows(food_by_age_income,
          health_by_age_income,
          education_by_age_income,
          childcare_by_age_income) %>%
  group_by(Total_income_decile, age_group) %>%
  summarise(total.expenditure = sum(est.expenditure) * GST_inflator_from0910_to1314) %>%
  mutate(age_group_text = gsub("\\s+", "\n", age_group)) %>%
  ungroup %>%
  mutate(extra_gst = 0.1 * total.expenditure)
```

```{r}
GST_by_age_and_income  %>%
  grplot(aes(x = factor(age_group_text),
             y = factor(Total_income_decile),
             alpha = extra_gst)) + 
  geom_tile(fill = Orange) +
  geom_text(data = tail(arrange(GST_by_age_and_income, extra_gst)),
            aes(label = grattan_dollar(extra_gst)),
            show_guide = FALSE) + 
  scale_alpha_continuous(label=grattan_dollar) + 
  scale_x_discrete(expand = c(0,0)) + 
  scale_y_discrete(expand = c(0,0)) + 
  xlab("Age") +
  coord_equal() + 
  theme_grattan(base_size = 18) +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "right",
        legend.key.size = unit(2, "lines"))
```

# Comparison to household numbers
```{r}
number_households_by_age_income <-
  hes10hh %>%
  mutate(
    age_group = as.character(Age_of_HH_reference_person),
    age_group = ifelse(grepl("^[0-9]+$", age_group), 
                       ifelse(as.numeric(age_group) < 20,
                              "20 or under",
                              paste((as.numeric(age_group) %/% 5) * 5,
                                    "to",
                                    (as.numeric(age_group) %/% 5) * 5 + 4)),
                       age_group
    )
  ) %>% 
  mutate(total.inc.deciles = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                   breaks = total.inc.deciles, 
                                                   include.lowest = TRUE)))) %>%
  group_by(age_group, total.inc.deciles) %>%
  summarise(number = sum(Weight_HH_HES)) %>%
  mutate(age_group_text = gsub("\\s+", "\n", age_group)) %>%
  ungroup 

number_households_by_age_income %>%
  grplot(aes(x = age_group_text,
             y = factor(total.inc.deciles),
             alpha = number)) + 
  geom_tile() +
  scale_x_discrete(expand = c(0,0)) + 
  scale_y_discrete(expand = c(0,0)) + 
  xlab("Age") +
  coord_equal() + 
  theme_grattan(base_size = 18) +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "right",
        legend.key.size = unit(2, "lines"))
  
  
```

# GST for deciles relative to welfare
```{r}
hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS
         , Current_weekly_HH_income_from_government_pensions_and_allowances
         , Age_of_HH_reference_person
         , Total_current_weekly_HH_income_from_all_sources) %>%
  group_by(
    Income_decile = ntile(Total_current_weekly_HH_income_from_all_sources, 10)
  ) %>%
  mutate(
    decile_cuts = min(Total_current_weekly_HH_income_from_all_sources)
  ) %>%
  grplot(aes(x = Total_current_weekly_HH_income_from_all_sources,
             y = Weekly_household_GST_on_all_goods_and_services_FIS)) + 
  geom_point(alpha = 0.2) + 
  geom_vline(aes(xintercept = decile_cuts), colour = theGrey, linetype = 2) + 
  stat_smooth()  + 
  scale_y_continuous(limits = c(0,300), 
                     label = grattan_dollar) + 
  scale_x_continuous(label = grattan_dollar,
                     limits = c(-2, 250e3/52)) 
```

## Perfect GST substitution
### Broadening the base
```{r}
HH_GST_expenditure_by_quintile <- 
  read_excel("HH_GST_expenditure_by_quintile.xlsx", sheet = "GST_by_quintile") %>% 
  gather(Quintile, weekly_expenditure, Q1:Q5) %>%
  filter(!grepl("[12]$", Category)) %>% #Education_1/2 are subcategories, may be ignored.
  group_by(total.inc.quintiles = as.integer(factor(Quintile))) %>%
  summarise(GST_expenditure = sum(weekly_expenditure)/10) %>%
  data.table %>%
  setkey(total.inc.quintiles) 

hes10hh %>%
  # get the quintiles:
  mutate(total.inc.quintiles = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                     breaks = total.inc.quintiles,  
                                                     include.lowest = TRUE))))   %>%
  inner_join(HH_GST_expenditure_by_quintile) %>%
  data.table %>%
  mutate(share_of_spending = GST_expenditure * Weight_HH_HES * 52.5 ) %>%
  group_by(total.inc.quintiles) %>%
  summarise(avg.pension = weighted.mean(Current_weekly_HH_income_from_government_pensions_and_allowances > 0, Weight_HH_HES))
```

### 15 per cent
```{r}
hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS
         , Current_weekly_HH_income_from_government_pensions_and_allowances
         , Age_of_HH_reference_person
         , Total_current_weekly_HH_income_from_all_sources) %>%
  group_by(
    Income_decile = ntile(Total_current_weekly_HH_income_from_all_sources, 10)
  ) %>%
  mutate(
    GST_extra = Weekly_household_GST_on_all_goods_and_services_FIS / 3,
    new_income_required = Current_weekly_HH_income_from_government_pensions_and_allowances + ifelse(Income_decile < 2,
                                                                                                    GST_extra,
                                                                                                    0)
  ) %>%
  grplot(aes(x = Total_current_weekly_HH_income_from_all_sources,
             y = Weekly_household_GST_on_all_goods_and_services_FIS)) +
  geom_point()
```

# GST for bottom 3 quintiles

# Household ratios of income
```{r}
hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS
         , Weekly_household_final_income_FIS
         , Weight_HH_HES
         , Household_weekly_expenditure_on_income_tax_HES_only) %>%
  mutate(ratio_GST = Weekly_household_GST_on_all_goods_and_services_FIS / Weekly_household_final_income_FIS) %>%
  group_by(Income_quintile = ntile(Weekly_household_final_income_FIS, 5)) %>%
  summarise(mean_ratio = weighted.mean(ratio_GST, w = Weight_HH_HES),
            #se_ratio = weighted.var.se(ratio_GST, w = Weight_HH_HES),
            max_income = max(Weekly_household_final_income_FIS * 52.5),
            mean_income_tax = weighted.mean(Household_weekly_expenditure_on_income_tax_HES_only, w = Weight_HH_HES),
            max_income_tax = max(Household_weekly_expenditure_on_income_tax_HES_only),
            prop_zero_income_tax = mean(Household_weekly_expenditure_on_income_tax_HES_only < 1)
            ) %>%
  arrange(Income_quintile) 
```

# Current base
## Current GST per household
```{r}
hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS
         , Total_current_weekly_HH_income_from_all_sources
         , Weekly_household_final_income_FIS
         , Weight_HH_HES
         , Household_weekly_expenditure_on_income_tax_HES_only) %>%
  group_by(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                     breaks = total.inc.quintiles,  
                                                     include.lowest = TRUE)))) %>%
  summarise(avg.GST = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS, 
                                    Weight_HH_HES)) %>%
  ungroup %>%
  mutate(prop.GST = avg.GST/sum(avg.GST)) %>%
  arrange(Gross_income_quintile)
```

```{r}
# GST_15_by_age_income <- 
#   hes10hh %>%
#   age_mutate %>%
#   group_by(# needs to be weighted Income_decile = ntile(Weekly_household_final_income_FIS, 10), age_group) %>%
#   summarise(avg.GST.15 = 1.5 * weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS, 
#                                              Weight_HH_HES)) %>%
#   ungroup %>%
#   mutate(avg.GST.15 = avg.GST.15 * GST_inflator_from0910_to1314) %>%
#   mutate(extra_gst = avg.GST.15 / 3)  # 5 percentage points = 15 / 3
```

```{r}
# GST_15_by_age_income  %>% 
#   grplot(aes(x = age_group, y = Income_decile, alpha = extra_gst)) + 
#   geom_tile(fill = Orange) +
#   geom_text(data = tail(arrange(GST_15_by_age_income, extra_gst)),
#             aes(label = grattan_dollar(extra_gst)),
#             show_guide = FALSE) + 
#   scale_alpha_continuous(label=grattan_dollar) + 
#   scale_x_discrete(expand = c(0,0)) + 
#   scale_y_discrete(expand = c(0,0)) + 
#   xlab("Age") +
#   coord_equal() + 
#   theme_grattan(base_size = 18) +
#   theme(panel.grid.major.y = element_blank(),
#         legend.position = "right",
#         legend.key.size = unit(2, "lines"))
```

# Deloitte study
I use the 2009-10 HES/FIS to estimate the effect of a 5 percentage point raise in a 10% GST. I then hardcoded the numbers from the Deloitte report to determine the size of their proposed compensatory transfers as a function of the extra GST raised. 
```{r}
# 15 pc.
extra_gst_raised <- 
  hes10hh %$%
  # Divide by 2 because 10/2 = 5, a 5 percentage point increase in GST.
  sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) * 52.5 / 2

compensatory.transfers <-
  # A quarter of money raised goes to tax cuts and transfers.
  # Transfers = 16 bn, tax cuts = 21 bn (which is over four years 
  # but that is relevant here).
  (1/4)*((16/(16+21)))*extra_gst_raised

proportion_of_welfare_by_quintile <-
  hes10hh %>% 
  group_by(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                         breaks = total.inc.quintiles,  
                                                         include.lowest = TRUE)))) %>%
  summarise(total_welfare = sum(Current_weekly_HH_income_from_government_pensions_and_allowances * Weight_HH_HES),
            extra_gst = sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) / 2) %>%
  ungroup %>%
  mutate(extra_gst.prop = extra_gst / sum(extra_gst),
         prop_welfare = total_welfare/sum(total_welfare),
         implied_transfr = prop_welfare * compensatory.transfers / 52.5,
         comp_adequacy = implied_transfr/extra_gst)
```


## Deloitte double donut
Assuming perfect precision in welfare means testing ('well-targeted payments'), 
```{r, fig.show='hide'}
data.frame(expense = c("Net revenue gain", "Personal tax cuts", "Transfer payments"),
                    number = c(115,21,16)) %>%
  mutate(fraction = number/sum(number)) %>%
  arrange(fraction) %>%
  mutate(ymax = cumsum(fraction),
         ymin = c(0, lag(ymax)[-1])) %>%
  grplot(aes(fill = expense, ymax = ymax, ymin = ymin, xmax = 4, xmin = 3)) + 
  geom_rect(colour = theGrey) + 
  geom_text(aes(x = 4.5, y = 0.5 * (ymin + ymax), label = expense)) +
  coord_polar(theta = "y") + 
  xlim(0,4.6) +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank())
```

```{r, fig.show='hide'}
proportion_of_welfare_by_quintile %>%
  mutate(fraction = extra_gst.prop) %>%
  arrange(fraction) %>%
  mutate(ymax = cumsum(fraction),
         ymin = c(0, lag(ymax)[-1])) %>%
  grplot(aes(fill = Gross_income_quintile, ymax = ymax, ymin = ymin, xmax = 4, xmin = 3)) + 
  geom_rect(colour = theGrey) + 
  geom_text(aes(x = 4.5, y = 0.5 * (ymin + ymax), label = Gross_income_quintile)) +
  coord_polar(theta = "y")+ 
  xlim(0,4.6) +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.line  = element_blank())
```


```{r}
outside <- 
  proportion_of_welfare_by_quintile %>%
  mutate(fraction = extra_gst.prop) %>%
  arrange(fraction) %>%
  mutate(ymax = cumsum(fraction),
         ymin = c(0, lag(ymax)[-1]))

inside <- 
  data.frame(expense = c("Net revenue gain", "Personal tax cuts", "Transfer payments"),
                    number = c(115,21,16)) %>%
  mutate(fraction = number/sum(number)) %>%
  arrange(fraction) %>%
  mutate(ymax = cumsum(fraction),
         ymin = c(0, lag(ymax)[-1]))

grplot(NULL) + 
  geom_rect(data = inside, aes(fill = expense, ymax = ymax, ymin = ymin, xmax = 3, xmin = 2)) + 
  geom_rect(data = outside, aes(fill = Gross_income_quintile, ymax = ymax, ymin = ymin, xmax = 4, xmin = 3)) + 
  coord_polar(theta = "y") + 
  xlim(0, 4.5) + 
  geom_text(data = outside, aes(x = 4.5, y = 0.5 * (ymin + ymax), label = Gross_income_quintile))  + 
  geom_text(data = inside, aes(x = 1.5, y = 0.5 * (ymin + ymax), label = expense)) +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank())
```

## But this does not paint the full picture
In reality, welfare payments cannot be perfectly targeted -- and certainly not to the bottom household. Past precision is the best performance of future precision, so I analyzed the 2009-10 Housing Expenditure Survey from the ABS to determine how well targeted welfare payments are. 

```{r, echo=TRUE, fig.height = 15, fig.width = 20}
welfare.by.income.quintile <- 
  hes10_indiv %>%
  merge(hes10hh, by = "Unique_household_number", suffixes = c("indiv", "hh")) %>%
  mutate(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                       breaks = total.inc.quintiles,  
                                                       include.lowest = TRUE)))) %>%
  select(Unique_household_number, Gross_income_quintile, 
         Weight_Person_HES, 
         Current_weekly_amount_of_Commonwealth_Rent_Assistance, Current_weekly_income_from_age_pension, Current_weekly_income_from_wife_pension, Current_weekly_income_from_carer_payment, 
         Current_weekly_income_from_carer_allowance, Current_weekly_income_from_special_benefit, Current_weekly_income_from_widow_allowance, Current_weekly_income_from_youth_allowance, Current_weekly_income_from_Austudy_Abstudy, Current_weekly_income_from_parenting_payment, Current_weekly_income_from_Baby_Bonus_payment, Current_weekly_income_from_partner_allowance, Current_weekly_income_from_senior_supplement, Current_weekly_income_from_newstart_allowance, Current_weekly_income_from_pension_supplement, Current_weekly_income_from_sickness_allowance, Current_weekly_income_from_service_pension_DVA, Current_weekly_income_from_utilities_allowance, Current_weekly_income_from_disability_pension_DVA, Current_weekly_income_from_war_widows_pension_DVA, Current_weekly_income_from_disability_support_pension, Current_weekly_income_from_family_tax_benefits_modelled, Current_weekly_income_from_other_government_pensions_and_allowances) %>%
  gather(Allowance, income, -Unique_household_number, -Gross_income_quintile, -Weight_Person_HES) %>%
  data.table %>%
  mutate(Allowance = gsub("Current_weekly_income_from_", "", Allowance, fixed = TRUE)) %>%
  group_by(Gross_income_quintile, Allowance) %>%
  summarise(total = sum(income * Weight_Person_HES)) %>%
  ungroup %>% 
  arrange(desc(total)) 


welfare.by.income.quintile %>%
  mutate(Allowance = factor(Allowance, levels = (welfare.by.income.quintile$Allowance), ordered = TRUE)) %>%
  mutate(text = ifelse(Gross_income_quintile == 2 & total > 1e7, gsub("_", " ", Allowance, fixed = TRUE), NA_character_)) %>%
  group_by(Gross_income_quintile) %>%
  arrange(desc(total)) %>%
  mutate(text.y = cumsum(total)) %>%
  ggplot(aes(x = Gross_income_quintile, fill = Allowance, order = Allowance)) + 
  geom_bar(aes(y = total), stat = "identity", position = "stack") + 
  geom_text(aes(label = text, y = text.y), vjust = 1, fontface = "bold", size = 5.5) + 
  scale_fill_manual(values = c(rep(RColorBrewer::brewer.pal(11, name="Spectral"), 2), "black")) + 
  scale_y_continuous("Weekly total income", label = grattan_dollar) + 
  theme_light(base_size = 18)
```

```{r, results = 'asis'}
proportion_of_welfare_by_quintile.tots <- 
  proportion_of_welfare_by_quintile %>% 
  ungroup %>%
  summarise(Total = sum)

proportion_of_welfare_by_quintile_pretty <- 
  proportion_of_welfare_by_quintile %>%
  arrange(Gross_income_quintile) %>%
  mutate(`Gross income quintile` = Gross_income_quintile,
         `Total welfare` = grattan_dollar(total_welfare * 52.5),
         `Increased GST burden` = grattan_dollar(extra_gst * 52.5),
         `(%)` = scales::percent(extra_gst.prop),
         `Share of total welfare` = scales::percent(prop_welfare),
         `Implied compensation` = grattan_dollar(implied_transfr * 52.5),
         `Adequacy of compo` = scales::percent(comp_adequacy)) %>%
  select(-contains("_"))

kable(proportion_of_welfare_by_quintile_pretty,
      align = rep("r", ncol(proportion_of_welfare_by_quintile_pretty)))
```



## Household expenditure per week by gross income 
```{r}
final.income.quintiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Weekly_household_final_income_FIS 
              ,.
              #, quantiles = c(0:5)/5)
              ,quantiles = c(0:5)/5
              )

hes10hh %>%
  group_by(
    Gross_income_quintile = factor(as.numeric(cut(Weekly_household_final_income_FIS, 
                                                     breaks = final.income.quintiles,  
                                                     include.lowest = TRUE)))
  ) %>%
  summarise(
    average_total_spending = weighted.mean(Total_household_expenditure_including_selected_other_payments_HES_only, Weight_HH_HES), 
    average_extra_gst = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS, Weight_HH_HES) / 2,
    average_welfare_payments = weighted.mean(Current_weekly_HH_income_from_government_pensions_and_allowances, Weight_HH_HES),
    average_income = weighted.mean(Weekly_household_final_income_FIS, Weight_HH_HES)
  ) %>% 
  arrange(Gross_income_quintile) %>%
  ungroup %>%
  mutate(prop_income_on_extra_gst = average_extra_gst / average_income,
         prop_income_spending = average_total_spending / average_income
         )

hes10hh %>%
  group_by(
    Gross_income_quintile = factor(as.numeric(cut(Weekly_household_final_income_FIS, 
                                                     breaks = final.income.quintiles,  
                                                     include.lowest = TRUE)))
  ) %>%
  mutate(extra_gst = Weekly_household_GST_on_all_goods_and_services_FIS / 2) %$%
  sum(extra_gst * Weight_HH_HES) * 52.5 ->
  extra_gst_raised

compensatory.transfers <-
  ((16/(16+21))/4)*extra_gst_raised   # p. 15 of report

hes10hh %>% 
  mutate(Gross_income_quintile = factor(as.numeric(cut(Weekly_household_final_income_FIS, 
                                                     breaks = final.income.quintiles,  
                                                     include.lowest = TRUE))),
         extra_gst = 52.5 * Weight_HH_HES * Weekly_household_GST_on_all_goods_and_services_FIS / 2,
         compensatory_transfer = ifelse(Gross_income_quintile == 1,
                                        compensatory.transfers / Weight_HH_HES,
                                        0),
         compensation_adequacy = compensatory_transfer / extra_gst) %>%
  group_by(Gross_income_quintile) %>%
  summarise(extra_gst_mean = weighted.mean(extra_gst, Weight_HH_HES),
            compensatory_transfer_mean = weighted.mean(compensatory_transfer, Weight_HH_HES)) %>%
  mutate(compensation_adequacy = compensatory_transfer_mean / extra_gst_mean)

```

```{r}
proportion_of_welfare_by_quintile <-
  hes10hh %>% 
  group_by(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                     breaks = total.inc.quintiles,  
                                                     include.lowest = TRUE)))) %>%
  summarise(total_welfare = sum(Current_weekly_HH_income_from_government_pensions_and_allowances * Weight_HH_HES),
            extra_gst = sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) / 2) %>%
  ungroup %>%
  mutate(prop_welfare = total_welfare/sum(total_welfare),
         implied_transfr = prop_welfare * compensatory.transfers / 52.5,
         comp_adequacy = implied_transfr/extra_gst)
```

## Tax cuts
By inspection of <https://grattan.shinyapps.io/Forty_three_app/Forty_three_app.Rmd> we see that a reduction in the bottom marginal tax rate from 19% to 15.5% results in a $5.6 billion decrease in revenue.

```{r}


```





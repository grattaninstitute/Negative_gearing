---
title: "GST expenditure by age and income, for categories"
author: "Hugh Parsonage"
output:
  html_document:
    css: floatToc.css
    theme: united
    toc: yes
    toc_depth: 3
  pdf_document:
    toc: yes
---

# What are the consumption patterns of different income quintiles?
This `Rmd` file attempts to determine the distributional impact of broadening the GST to include currently exempt food, education, health, and childcare. We use the ABS's Household Expenditure Survey 2009-10, being the most recent survey containing this information. 

Some issues:

+ No behaviour change. We assume there will be no change (*i.e.* no reduction) in consumption of items currently GST exempt.
+ Health expenditure is dubious. Highly volatile spending. 
+ Fresh food is available for each quintile. We assume the relationship between spending on GST-exempt food and income is linear and does not change across age groups. 
+ Education spending not availble except aggregated by household income and household age head of household. We assume that the relationship between spending and income is the same across each age group. 
+ Education and childcare spending only available by quintile. We assume that half the total spending in a quintile goes to each decile.

```{r, results='hide'}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      cache=TRUE,
                      fig.height=8, fig.width=10)
```

```{r, cache=FALSE}
library(ggplot2)
library(scales)
library(grattan)
library(VIM) # VIM::hotdeck used for imputation
library(dplyr)
library(foreign)
library(survey)
library(data.table)
library(readxl)
library(readr)
library(tidyr)
library(magrittr)
library(httr)

weighted.var.se <- function(x, w, na.rm=FALSE){
  # Computes the variance of a weighted mean following Cochran 1977 definition
  # http://stats.stackexchange.com/questions/25895/computing-standard-error-in-weighted-mean-estimation
  if (na.rm) { w <- w[i <- !is.na(x)]; x <- x[i] }
  n = length(w)
  xWbar = weighted.mean(x,w,na.rm=na.rm)
  wbar = mean(w)
  out = n/((n-1)*sum(w)^2)*(sum((w*x-wbar*xWbar)^2)-2*xWbar*sum((w-wbar)*(w*x-wbar*xWbar))+xWbar^2*sum((w-wbar)^2))
  return(out)
}

age_mutate <- function(.hes){
  if("Age_of_HH_reference_person" %in% names(.hes)){
    .hes %>%
      mutate(
        age_group = as.character(Age_of_HH_reference_person),
        age_group = ifelse(grepl("^[0-9]+$", age_group), 
                           ifelse(as.numeric(age_group) < 20,
                                  "20 or under",
                                  paste((as.numeric(age_group) %/% 5) * 5,
                                        "to",
                                        (as.numeric(age_group) %/% 5) * 5 + 4)),
                           age_group
        )
      )
  }
  
  if("Age_of_person" %in% names(.hes)){
    .hes %>%
      mutate(
        age_group = as.character(Age_of_person),
        age_group = ifelse(grepl("^[0-9]+$", age_group), 
                           ifelse(as.numeric(age_group) < 20,
                                  "20 or under",
                                  paste((as.numeric(age_group) %/% 5) * 5,
                                        "to",
                                        (as.numeric(age_group) %/% 5) * 5 + 4)),
                           age_group
        )
      )
  }
  
}

group_by.income_quintile <- function(.data, type = "Total_current_weekly_HH_income_from_all_sources"){
  if(type == "Current_weekly_HH_disposable_income"){
    group_by(.data, income_quintile = factor(as.numeric(cut(Current_weekly_HH_disposable_income, 
                                                            breaks = total.inc.quintiles, 
                                                            include.lowest = TRUE)))) %>%
      arrange(income_quintile)
  } else {
    if (type == "Total_current_weekly_HH_income_from_all_sources"){
      group_by(.data, income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                            breaks = total.inc.quintiles, 
                                                            include.lowest = TRUE)))) %>%
      arrange(income_quintile)
    }
  }
}


# for asymmetric expansion of limits
scale_dimension.custom_expand <- function(scale, expand = ggplot2:::scale_expand(scale)) {
  expand_range(ggplot2:::scale_limits(scale), expand[[1]], expand[[2]])
}

scale_y_continuous <- function(...) {
  s <- ggplot2::scale_y_continuous(...)
  class(s) <- c('custom_expand', class(s))
  s
}

scale_x_continuous <- function(...) {
  s <- ggplot2::scale_x_continuous(...)
  class(s) <- c('custom_expand', class(s))
  s
}

scale_x_date <- function(...) {
  s <- ggplot2::scale_x_date(...)
  class(s) <- c('custom_expand', class(s))
  s
}

# Taxation statistics 2012-13 Goods and services tax: Selected GST, WET and LCT items, 2001-02 to 2013-14 financial years
if(!file.exists("GST_by_year.xlsx")){
  GST_url <- "http://data.gov.au/dataset/e29ef9ca-0d1a-47ec-9e9b-14a79a941511/resource/0e56ca39-832e-40ca-bc62-297a3fb552cf/download/taxstats2013gst1gstwetlctmultiyear.xlsx"
  GET(GST_url, write_disk("GST_by_year.xlsx"))
}
GST_inflator_from0910_to1314 <-
  read_excel("GST_by_year.xlsx", sheet = "GST Table 1", skip = 2) %>%
  setnames(1:2, c("Selected_item", "unit")) %>% 
  # en dash caution
  setnames(old = names(.), new = gsub("([0-9]{4}).([0-9]{2})", "\\1-\\2", names(.))) %>%
  gather(year, value, `2001-02`:`2013-14`) %>%
  mutate(value = as.numeric(value)) %>%
  filter(complete.cases(.)) %>%
  filter(grepl("Net.GST", Selected_item)) %>%
  filter(grepl("^((2009)|(2012)|(2013))", year)) %$%
  {last(value) / first(value)}

GST_inflator_from0910_to1213 <-
  read_excel("GST_by_year.xlsx", sheet = "GST Table 1", skip = 2) %>%
  setnames(1:2, c("Selected_item", "unit")) %>% 
  # en dash caution
  setnames(old = names(.), new = gsub("([0-9]{4}).([0-9]{2})", "\\1-\\2", names(.))) %>%
  gather(year, value, `2001-02`:`2013-14`) %>%
  mutate(value = as.numeric(value)) %>%
  filter(complete.cases(.)) %>%
  filter(grepl("Net.GST", Selected_item)) %>%
  filter(grepl("^((2009)|(2012))", year)) %$%
  {last(value) / first(value)}
```
Our first task is to make the HES variables meaningful. Do you know what `INCTOPH8` means? Let's find out! The way I did that was to link the variables in the variable listings excel file to the definition therein. We also have to make the variables suitable for R, *viz* no spaces or weird characters.
```{r}
hes10hh_raw <- read.dta("./HES/hes10bh.dta")

hes.sih.vars <- read_excel("./SIH/HES_and_SIH_variable_listing.xlsx") 

# See page 21 of HES 2009-10 user guide
# http://www.ausstats.abs.gov.au/ausstats/subscriber.nsf/0/1D03ACBBD40275ADCA257A3900173E85/$File/65030_1.pdf
hes.sih.vars %<>%
  mutate(Definition = ifelse(HES_basic_name == "COICEXP", paste0(Definition, "_COICOP"), Definition))

hes.sih.vars %<>%
  gather(GROUP, variable, -Definition) %>%
  mutate(variable = gsub("[^A-Za-z0-9]", "", variable)) %>%
  filter(complete.cases(.)) %>%
  spread(GROUP, variable) %>%
  mutate(
    # replace all nonletters with _ unless they occur at the end of the name,
    # in which case delete it
    Definition_new = gsub("[^A-Za-z]+(?!$)", "_", Definition, perl = TRUE),
    Definition_new = gsub("[^A-Za-z]+$", "", Definition_new)
  )
```

```{r}
hes10hh.names <- 
  hes.sih.vars$HES_basic_name[hes.sih.vars$HES_basic_name %in% names(hes10hh_raw)]
hes10hh.newnames <-
  hes.sih.vars$Definition_new[hes.sih.vars$HES_basic_name %in% names(hes10hh_raw)]

hes10hh <-
  hes10hh_raw %>%
  # This omits some weights and PETTAX (hh consumption of fuel tax) for some reason
  select_(.dots = hes10hh.names) %>%
  data.table %>%
  setnames(old = hes10hh.names, 
           new = hes10hh.newnames)
```
We now have an object, `hes10hh`, with meaningful column names. I prefer the following values for our ages:
```{r}
# Age cleaning
hes10hh %<>%
  mutate(
    Age_of_HH_reference_person = factor(gsub(" years",
                                             "",
                                             Age_of_HH_reference_person))
  ) 
```
## Calculation of quantiles.
We will only use the quintiles and deciles.
```{r}
disp.inc.percentiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Current_weekly_HH_disposable_income # disposable income
              ,.
              ,quantiles = c(0:100)/100)
disp.inc.deciles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Current_weekly_HH_disposable_income 
              ,.
              , quantiles = c(0:10)/10)

total.inc.percentiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Total_current_weekly_HH_income_from_all_sources 
              ,.
              , quantiles = c(0:100)/100)

total.inc.deciles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Total_current_weekly_HH_income_from_all_sources 
              ,.
              , quantiles = c(0:10)/10)

total.inc.quintiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Total_current_weekly_HH_income_from_all_sources 
              ,.
              #, quantiles = c(0:5)/5)
              ,quantiles = c(0:5)/5)


hes10hh %<>%
  mutate(income.percentile = factor(as.numeric(cut(Current_weekly_HH_employee_income, 
                                                   breaks = disp.inc.percentiles, 
                                                   include.lowest = TRUE)))) 
```


```{r}
hes10hh %>%
  group_by(income.percentile) %>%
  summarise(mean = weighted.mean(Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, w = Weight_HH_HES),
            se = sqrt(weighted.var.se(Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, w = Weight_HH_HES))) %>%
  arrange(income.percentile) 

food_by_age <- 
  hes10hh %>%
  mutate(
    age_group = as.character(Age_of_HH_reference_person),
    age_group = ifelse(grepl("^[0-9]+$", age_group), 
                       ifelse(as.numeric(age_group) < 20,
                              "20 or under",
                              paste((as.numeric(age_group) %/% 5) * 5,
                                    "to",
                                    (as.numeric(age_group) %/% 5) * 5 + 4)),
                       age_group
    )
  ) %>% 
  mutate(total.inc.deciles = factor(as.numeric(cut(Current_weekly_HH_employee_income, 
                                                   breaks = total.inc.deciles, 
                                                   include.lowest = TRUE)))) %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyby(~Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, ~total.inc.deciles + age_group, ., svymean,
        keep.names = FALSE) %>%
  setnames(c("Total_income_decile", 
             "age_group",
             "Food_exp.avg",
             "se")) %>%
  # cosmetic
  setattr(c("call", "svyby"), c(NULL, NULL)) %>%
  mutate(Total_income_decile = as.integer(as.character(Total_income_decile)))


```

## Individuals

```{r}
hes10_indiv_raw <- 
  read.dta("./HES/hes10bp.dta")

hes10hp.names <- 
  hes.sih.vars$HES_basic_name[hes.sih.vars$HES_basic_name %in% names(hes10_indiv_raw)]
hes10hp.newnames <-
  hes.sih.vars$Definition_new[hes.sih.vars$HES_basic_name %in% names(hes10_indiv_raw)]

hes10_indiv <- 
  hes10_indiv_raw %>%
  data.table %>%
  select_(.dots = hes10hp.names) %>%
  setnames(old = hes10hp.names, 
           new = hes10hp.newnames)

total.inc.deciles_indiv <- 
  hes10_indiv_raw %>%
  svydesign(~ABSPID, data = ., weights = ~HESPSWT) %>%
  svyquantile(~INCTSCP8 # total weekly income from all sources
              ,.
              , quantiles = c(0:10)/10)

total.inc.quintiles_indiv <- 
  hes10_indiv_raw %>%
  svydesign(~ABSPID, data = ., weights = ~HESPSWT) %>%
  svyquantile(~INCTSCP8 # total weekly income from all sources
              ,.
              , quantiles = c(0:5)/5)

# hes10_indiv %>%
#   mutate(tot.inc.deciles = factor(as.numeric(cut(Total_current_weekly_income_from_all_sources, 
#                                                   breaks = total.inc.deciles_indiv, 
#                                                   include.lowest = TRUE)))) %>%
#   svydesign(~Person_number_within_each_income_unit, data = ., weights = ~Weight_Person_HES) %>%
#   svyby(~Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, 
#         by = ~tot.inc.deciles + Age_of_person,
#         svymean)

```

```{r}
HH_GST_expenditure_by_quintile <- 
  read_excel("HH_GST_expenditure_by_quintile.xlsx", sheet = "GST_by_quintile") %>% 
  gather(Quintile, weekly_expenditure, Q1:Q5) %>%
  filter(!grepl("[12]$", Category)) 
```

```{r}
HH_food_expenditure_by_decile.age <- 
  hes10hh %>%
  mutate(
    age_group = as.character(Age_of_HH_reference_person),
    age_group = ifelse(grepl("^[0-9]+$", age_group), 
                       ifelse(as.numeric(age_group) < 20,
                              "20 or under",
                              paste((as.numeric(age_group) %/% 5) * 5,
                                    "to",
                                    (as.numeric(age_group) %/% 5) * 5 + 4)),
                       age_group
    )
  ) %>% 
  mutate(Total_income_decile = factor(as.numeric(cut(Current_weekly_HH_disposable_income, 
                                                   breaks = total.inc.deciles, 
                                                   include.lowest = TRUE)))) 
```

## Determining the GST expenditure for each category, for each age and income decile
### Household quintiles
```{r}
HH_GST_expenditure_by_quintile %<>%
  mutate(
    quantile = as.numeric(gsub("Q", "", Quintile)),
    quantile = (quantile / 5) - 0.1 - (quantile < 3) * 0.05 + (quantile > 3) * 0.05,
    Quintile = as.integer(gsub("Q", "", Quintile))
  ) 
```

```{r}
food_and_income.gst <- 
  hes10hh %>% 
  mutate(total.inc.quintiles = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                     breaks = total.inc.quintiles,  # Total current weekly HH income from all sources
                                                     include.lowest = TRUE)))) %>% 
  group_by(total.inc.quintiles) %>% 
  summarise(
    average_food = weighted.mean(Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, 
                                 w = Weight_HH_HES)) %>% 
  data.frame %>% 
  merge(filter(HH_GST_expenditure_by_quintile, Category == "Food"), by.x = "total.inc.quintiles", by.y = "Quintile") %>% 
  setnames("weekly_expenditure", "weekly_exp_GST_liable_food") %>%
  mutate(prop = weekly_exp_GST_liable_food/average_food) %>%
  merge(data.frame(quantile = (0:20)/20), all.y = TRUE, all.x = TRUE) %>%
  do(data.frame(., pred_prop_GST = predict(lm(prop ~ quantile, data = .), newdata=.))) %>%
  select(quantile, pred_prop_GST) %>%
  # BEWARE FLOATING POINT ARITHMETIC
  dplyr::filter(quantile %in% c(0.05, 0.15, 0.25, 0.35, 0.45, 0.55, 0.65, 0.75, 0.85, 0.95)) %>%
  mutate(Total_income_decile = as.integer(factor(quantile)))
```
### Food consumption by age
```{r}
chessboard <- 
  data.table::CJ(
    unique(HH_food_expenditure_by_decile.age$age_group),
    1:10
  ) %>%
  setnames(old = paste0("V", 1:2), new = c("age_group", "Total_income_decile"))

food_by_age_income <- 
  HH_food_expenditure_by_decile.age %>%
  merge(chessboard, by = c("age_group", "Total_income_decile"), all.y = TRUE) %>%
  ## HOT DECK 
  VIM::hotdeck(., variable = "Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only") %>%
  VIM::hotdeck(., variable = "Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only") %>%
  # this is to ensure smooth execution of code with following design objects
  mutate(Unique_household_number = ifelse(is.na(Unique_household_number), 
                                          paste0(lag(Unique_household_number), "x"),
                                          Unique_household_number),
         Weight_HH_HES = ifelse(is.na(Weight_HH_HES),
                                max(Weight_HH_HES, na.rm = TRUE),
                                Weight_HH_HES)) %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyby(~Household_weekly_expenditure_on_food_and_non_alcoholic_beverages_HES_only, ~Total_income_decile + age_group, ., svymean, keep.names = FALSE) %>%
  setnames(c("Total_income_decile", 
             "age_group",
             "Food_exp.avg",
             "se")) %>%
  setattr(c("call", "svyby"), c(NULL, NULL)) %>%
  mutate(Total_income_decile = as.integer(as.character(Total_income_decile))) %>%
  merge(food_and_income.gst, by = "Total_income_decile") %>%
  mutate(Food_GST = Food_exp.avg * pred_prop_GST) %>%
  mutate(age_group_text = gsub("\\s+", "\n", age_group))

food_by_age_income %>%
  grplot(aes(x = age_group_text, y = factor(Total_income_decile), alpha = Food_GST)) + 
  geom_tile(fill = Orange) + 
  geom_point(data = filter(food_by_age_income, 1.96 * se > Food_GST | se == 0),
             aes(size = se/Food_GST,
                 shape = se == 0),
             color = "red", alpha= 1) + 
  scale_alpha_continuous(label=grattan_dollar) + 
  xlab("Age group") + 
  scale_shape_manual(values = c(23, 24)) +
  coord_equal() + 
  theme_grattan(base_size = 18) +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "right")
```

## Health
```{r}
health_by_age_income <-
  hes10hh %>%
  mutate(
    age_group = as.character(Age_of_HH_reference_person),
    age_group = ifelse(grepl("^[0-9]+$", age_group), 
                       ifelse(as.numeric(age_group) < 20,
                              "20 or under",
                              paste((as.numeric(age_group) %/% 5) * 5,
                                    "to",
                                    (as.numeric(age_group) %/% 5) * 5 + 4)),
                       age_group
    )
  ) %>% 
  mutate(Total_income_decile = factor(as.numeric(cut(Current_weekly_HH_disposable_income, 
                                                   breaks = total.inc.deciles, 
                                                   include.lowest = TRUE)))) %>%
  merge(chessboard, by = c("age_group", "Total_income_decile"), all.y = TRUE) %>%
  ## HOT DECK 
  VIM::hotdeck(., variable = "Household_weekly_expenditure_on_medical_care_and_health_expenses_HES_only") %>%
  mutate(Unique_household_number = ifelse(is.na(Unique_household_number), 
                                          paste0(lag(Unique_household_number), "x"),
                                          Unique_household_number),
         Weight_HH_HES = ifelse(is.na(Weight_HH_HES),
                                max(Weight_HH_HES, na.rm = TRUE),
                                Weight_HH_HES)) %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyby(~Household_weekly_expenditure_on_medical_care_and_health_expenses_HES_only, ~Total_income_decile + age_group, ., svymean) %>%  
  setnames(c("Total_income_decile", 
             "age_group",
             "Health_exp.avg",
             "se")) %>%
  setattr(c("call", "svyby"), c(NULL, NULL)) %>%
  mutate(Total_income_decile = as.integer(as.character(Total_income_decile))) %>%
  mutate(age_group_text = gsub("\\s+", "\n", age_group)) 

grplot(data = health_by_age_income,
       aes(x = age_group_text,
           y = Total_income_decile, 
           alpha = Health_exp.avg)) + 
  geom_tile(fill = Orange) + 
  # se == 0 is also suspicious: it suggests there was only one observation in that group.
  geom_point(data = filter(health_by_age_income, 1.96 * se > Health_exp.avg | se == 0),
             aes(size = se/Health_exp.avg,
                 shape = se == 0),
             color = "red", alpha= 1) + 
  xlab("Age group") + 
  scale_shape_manual(values = c(23, 24)) +
  scale_alpha_continuous(label=grattan_dollar) +
  coord_equal() + 
  theme_grattan(base_size = 18) +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "right")
```

# Expand quintiles to deciles
## Split the difference

## Education
```{r}
education_by_incomeQ <- 
  read_excel("Education_HES10_detailed.xlsx", sheet = "Education_by_income") %>%
  filter(as.logical(Total)) %>% select(-Total, -Subgroup) %>%
  gather(Quintile, amount, Q1:Q5) %>%
  mutate(amount = as.numeric(gsub("*", "", amount, fixed = TRUE))) %>%
  mutate(Quintile = as.integer(gsub("Q", "", Quintile))) %>%
  group_by(Quintile) %>%
  summarise(education.exp.Q = sum(amount)) %>%
  ungroup %>%
  mutate(education.exp.prop.Q = education.exp.Q / sum(education.exp.Q)) %>%
  data.table %>%
  setkey(Quintile)

education_by_age.names <- 
  read_excel("Education_HES10_detailed.xlsx", sheet = "Education_by_age") %>%
  names

education_by_age <- 
  read_excel("Education_HES10_detailed.xlsx", sheet = "Education_by_age") %>%
  gather_("age_group", "amount", grep("^[1-9]", education_by_age.names, value = TRUE)) %>%
  filter(as.logical(Total)) %>% select(-Total, -Subgroup) %>%
  mutate(amount = as.numeric(gsub("*", "", amount, fixed = TRUE))) %>%
  group_by(age_group) %>%
  summarise(education.exp.age = sum(amount)) %>%
  ungroup %>%
  mutate(education.exp.prop.age = education.exp.age / sum(education.exp.age)) %>%
  data.table %>% 
  setkey(age_group)

# Assume that every age has the same distribution of education expenses by income
education_by_age_income <-
data.table::CJ(
  Quintile = c(1:5, (1:5-0.5)),
  age_group = education_by_age$age_group
) %>%
  merge(., education_by_age, by = "age_group") %>%
  setkey(Quintile) %>%
  merge(., education_by_incomeQ) %>%
  mutate(est.education.spend = education.exp.age * education.exp.prop.Q) %>%
  right_join(.,
    data.table(Quintile = rep(1:5, each = 2),
               Decile = 1:10)
  ) %>%
  mutate(
    education.exp.est_decile = est.education.spend / 2
  )
```

# Childcare
```{r}
childcare_by_age <- 
  read_excel("EducationChildcare_HES10_detailed.xlsx", sheet = "Childcare_by_age") %>%
  gather(age_group, child_care.expAge, -Group) %>%
  data.table

childcare_by_income <-
  read_excel("EducationChildcare_HES10_detailed.xlsx", sheet = "Childcare_by_income") %>%
  gather(Quintile, child_care.expQ, -Group) %>%
  mutate(Quintile = as.integer(factor(Quintile))) %>%
  filter(complete.cases(.)) %>%
  mutate(child_care.expQ.prop = child_care.expQ/sum(child_care.expQ)) %>%
  data.table

childcare_by_age_income <- 
  data.table::CJ(
    Quintile = 1:5,
    age_group = childcare_by_age$age_group
  ) %>%
  setkey(Quintile) %>%
  merge(., childcare_by_income) %>%
  setkey(age_group) %>%
  merge(., childcare_by_age) %>%
  mutate(child_care.exp.est = child_care.expAge * child_care.expQ.prop) %>%
  select(age_group, Quintile, child_care.exp.est) %>%
  right_join(.,
    data.table(Quintile = rep(1:5, each = 2),
               Decile = 1:10)
  ) %>%
  mutate(
    child_care.exp.est_decile = child_care.exp.est / 2
  ) 
```

# All together now
```{r}
age_group_tbl <- 
  fread("age_table.csv")

food_by_age_income %<>%
  select(Total_income_decile, age_group, Food_GST) %>%
  # Check that this is indeed the right variable
  setnames("Food_GST", "est.expenditure") %>%
  mutate(Group = "Food")

health_by_age_income %<>%
  select(Total_income_decile, age_group, Health_exp.avg) %>%
  setnames("Health_exp.avg", "est.expenditure") %>%
  mutate(Group = "Health")

education_by_age_income %<>%
  select(Decile, age_group, est.education.spend) %>%
  # Note that this is not strictly true: it's household income.
  setnames(c("Decile", "est.education.spend"), 
           c("Total_income_decile", "est.expenditure")) %>%
  merge(., age_group_tbl, by.x = "age_group", by.y = "big_age") %>%
  group_by(Total_income_decile, little_age) %>%
  # assign equally among each subage
  mutate(n = n()) %>%
  mutate(est.expenditure = est.expenditure / n) %>%
  mutate(Group = "Education")  %>%
  setnames("little_age", "age_group")

childcare_by_age_income %<>%
  select(Decile, age_group, child_care.exp.est_decile) %>%
  setnames(c("Decile", "child_care.exp.est_decile"), 
           c("Total_income_decile", "est.expenditure")) %>%
  merge(., age_group_tbl, by.x = "age_group", by.y = "big_age") %>%
  group_by(Total_income_decile, little_age) %>%
  # assign equally among each subage
  mutate(n = n()) %>%
  mutate(est.expenditure = est.expenditure / n) %>%
  mutate(Group = "Childcare") %>%
  setnames("little_age", "age_group")

GST_by_age_and_income <- 
bind_rows(food_by_age_income,
          health_by_age_income,
          education_by_age_income,
          childcare_by_age_income) %>%
  group_by(Total_income_decile, age_group) %>%
  summarise(total.expenditure = sum(est.expenditure) * GST_inflator_from0910_to1314) %>%
  mutate(age_group_text = gsub("\\s+", "\n", age_group)) %>%
  ungroup %>%
  mutate(extra_gst = 0.1 * total.expenditure)
```

```{r}
GST_by_age_and_income  %>%
  grplot(aes(x = factor(age_group_text),
             y = factor(Total_income_decile),
             alpha = extra_gst)) + 
  geom_tile(fill = Orange) +
  geom_text(data = tail(arrange(GST_by_age_and_income, extra_gst)),
            aes(label = grattan_dollar(extra_gst)),
            show_guide = FALSE) + 
  scale_alpha_continuous(label=grattan_dollar) + 
  scale_x_discrete(expand = c(0,0)) + 
  scale_y_discrete(expand = c(0,0)) + 
  xlab("Age") +
  coord_equal() + 
  theme_grattan(base_size = 18) +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "right",
        legend.key.size = unit(2, "lines"))
```

# Comparison to household numbers
```{r}
number_households_by_age_income <-
  hes10hh %>%
  mutate(
    age_group = as.character(Age_of_HH_reference_person),
    age_group = ifelse(grepl("^[0-9]+$", age_group), 
                       ifelse(as.numeric(age_group) < 20,
                              "20 or under",
                              paste((as.numeric(age_group) %/% 5) * 5,
                                    "to",
                                    (as.numeric(age_group) %/% 5) * 5 + 4)),
                       age_group
    )
  ) %>% 
  mutate(total.inc.deciles = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                   breaks = total.inc.deciles, 
                                                   include.lowest = TRUE)))) %>%
  group_by(age_group, total.inc.deciles) %>%
  summarise(number = sum(Weight_HH_HES)) %>%
  mutate(age_group_text = gsub("\\s+", "\n", age_group)) %>%
  ungroup 

number_households_by_age_income %>%
  grplot(aes(x = age_group_text,
             y = factor(total.inc.deciles),
             alpha = number)) + 
  geom_tile() +
  scale_x_discrete(expand = c(0,0)) + 
  scale_y_discrete(expand = c(0,0)) + 
  xlab("Age") +
  coord_equal() + 
  theme_grattan(base_size = 18) +
  theme(panel.grid.major.y = element_blank(),
        legend.position = "right",
        legend.key.size = unit(2, "lines"))
  
  
```

# GST for deciles relative to welfare
```{r}
hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS
         , Current_weekly_HH_income_from_government_pensions_and_allowances
         , Age_of_HH_reference_person
         , Total_current_weekly_HH_income_from_all_sources) %>%
  group_by(
    Income_decile = ntile(Total_current_weekly_HH_income_from_all_sources, 10)
  ) %>%
  mutate(
    decile_cuts = min(Total_current_weekly_HH_income_from_all_sources)
  ) %>%
  grplot(aes(x = Total_current_weekly_HH_income_from_all_sources,
             y = Weekly_household_GST_on_all_goods_and_services_FIS)) + 
  geom_point(alpha = 0.2) + 
  geom_vline(aes(xintercept = decile_cuts), colour = theGrey, linetype = 2) + 
  stat_smooth()  + 
  scale_y_continuous("Weekly GST",
                     limits = c(0,300), 
                     label = grattan_dollar) + 
  scale_x_continuous(label = grattan_dollar,
                     limits = c(-2, 250e3/52)) +
  theme(axis.title.y = element_text(angle = 90)) + 
  annotate("text", 
           x = 1000,
           y = 300,
           vjust = 1,
           size = 7.14,
           label = "income deciles")
```

```{r}
lm.income.gst <- lm(Weekly_household_GST_on_all_goods_and_services_FIS ~ Total_current_weekly_HH_income_from_all_sources,
                    data = hes10hh, weights = Weight_HH_HES)

hes10hh.pred <- 
  predict(lm.income.gst, interval = "prediction") %>%
  cbind(Total_current_weekly_HH_income_from_all_sources = hes10hh$Total_current_weekly_HH_income_from_all_sources_basis) %>%
  as.data.frame %>%
  tbl_df

hes10hh %>%
  #group_by.income_quintile %>%
  grplot(aes(x = Total_current_weekly_HH_income_from_all_sources
             #,y = Weekly_household_GST_on_all_goods_and_services_FIS)
             )) + 
  #geom_point(aes(alpha = Weight_HH_HES/max(Weight_HH_HES))) +
  geom_ribbon(data = hes10hh.pred,
              mapping = aes(ymax = upr, ymin = lwr)) + 
  scale_alpha_identity() + 
  xlim(-5, 10e3)
```

## Perfect GST substitution
### Broadening the base
```{r}
HH_GST_expenditure_by_quintile <- 
  read_excel("HH_GST_expenditure_by_quintile.xlsx", sheet = "GST_by_quintile") %>% 
  gather(Quintile, weekly_expenditure, Q1:Q5) %>%
  filter(!grepl("[12]$", Category)) %>% #Education_1/2 are subcategories, may be ignored.
  group_by(total.inc.quintiles = as.integer(factor(Quintile))) %>%
  summarise(GST_expenditure = sum(weekly_expenditure)/10) %>%
  data.table %>%
  setkey(total.inc.quintiles) 

hes10hh %>%
  # get the quintiles:
  mutate(total.inc.quintiles = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                     breaks = total.inc.quintiles,  
                                                     include.lowest = TRUE))))   %>%
  inner_join(HH_GST_expenditure_by_quintile) %>%
  data.table %>%
  mutate(share_of_spending = GST_expenditure * Weight_HH_HES * 52.5 ) %>%
  group_by(total.inc.quintiles) %>%
  summarise(avg.pension = weighted.mean(Current_weekly_HH_income_from_government_pensions_and_allowances > 0, Weight_HH_HES))
```

### 15 per cent
```{r, fig.show='hide'}
hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS
         , Current_weekly_HH_income_from_government_pensions_and_allowances
         , Age_of_HH_reference_person
         , Total_current_weekly_HH_income_from_all_sources) %>%
  group_by(
    Income_decile = ntile(Total_current_weekly_HH_income_from_all_sources, 10)
  ) %>%
  mutate(
    GST_extra = Weekly_household_GST_on_all_goods_and_services_FIS / 3,
    new_income_required = Current_weekly_HH_income_from_government_pensions_and_allowances + ifelse(Income_decile < 2,
                                                                                                    GST_extra,
                                                                                                    0)
  ) %>%
  grplot(aes(x = Total_current_weekly_HH_income_from_all_sources,
             y = Weekly_household_GST_on_all_goods_and_services_FIS)) +
  geom_point() + 
  ylab("Weekly GST") 
```

# GST for bottom 3 quintiles

# Household ratios of income
```{r}
hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS
         , Weekly_household_final_income_FIS
         , Weight_HH_HES
         , Household_weekly_expenditure_on_income_tax_HES_only) %>%
  mutate(ratio_GST = Weekly_household_GST_on_all_goods_and_services_FIS / Weekly_household_final_income_FIS) %>%
  group_by(Income_quintile = ntile(Weekly_household_final_income_FIS, 5)) %>%
  summarise(mean_ratio = weighted.mean(ratio_GST, w = Weight_HH_HES),
            #se_ratio = weighted.var.se(ratio_GST, w = Weight_HH_HES),
            max_income = max(Weekly_household_final_income_FIS * 52.5),
            mean_income_tax = weighted.mean(Household_weekly_expenditure_on_income_tax_HES_only, w = Weight_HH_HES),
            max_income_tax = max(Household_weekly_expenditure_on_income_tax_HES_only),
            prop_zero_income_tax = mean(Household_weekly_expenditure_on_income_tax_HES_only < 1)
            ) %>%
  arrange(Income_quintile) 
```

# Current base
## Current GST per household
```{r}
hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS
         , Total_current_weekly_HH_income_from_all_sources
         , Weekly_household_final_income_FIS
         , Weight_HH_HES
         , Household_weekly_expenditure_on_income_tax_HES_only) %>%
  group_by(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                     breaks = total.inc.quintiles,  
                                                     include.lowest = TRUE)))) %>%
  summarise(avg.GST = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS, 
                                    Weight_HH_HES)) %>%
  ungroup %>%
  mutate(prop.GST = avg.GST/sum(avg.GST)) %>%
  arrange(Gross_income_quintile)
```

```{r}
# GST_15_by_age_income <- 
#   hes10hh %>%
#   age_mutate %>%
#   group_by(# needs to be weighted Income_decile = ntile(Weekly_household_final_income_FIS, 10), age_group) %>%
#   summarise(avg.GST.15 = 1.5 * weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS, 
#                                              Weight_HH_HES)) %>%
#   ungroup %>%
#   mutate(avg.GST.15 = avg.GST.15 * GST_inflator_from0910_to1314) %>%
#   mutate(extra_gst = avg.GST.15 / 3)  # 5 percentage points = 15 / 3
```

```{r}
# GST_15_by_age_income  %>% 
#   grplot(aes(x = age_group, y = Income_decile, alpha = extra_gst)) + 
#   geom_tile(fill = Orange) +
#   geom_text(data = tail(arrange(GST_15_by_age_income, extra_gst)),
#             aes(label = grattan_dollar(extra_gst)),
#             show_guide = FALSE) + 
#   scale_alpha_continuous(label=grattan_dollar) + 
#   scale_x_discrete(expand = c(0,0)) + 
#   scale_y_discrete(expand = c(0,0)) + 
#   xlab("Age") +
#   coord_equal() + 
#   theme_grattan(base_size = 18) +
#   theme(panel.grid.major.y = element_blank(),
#         legend.position = "right",
#         legend.key.size = unit(2, "lines"))
```

# Deloitte study
I use the 2009-10 HES/FIS to estimate the effect of a 5 percentage point raise in a 10% GST. I then hardcoded the numbers from the Deloitte report to determine the size of their proposed compensatory transfers as a function of the extra GST raised. 
```{r}
# 15 pc.
extra_gst_raised <- 
  hes10hh %$%
  # Divide by 2 because 10/2 = 5, a 5 percentage point increase in GST.
  sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) * 52.5 / 2

welfare.from.hes <- 
  hes10hh %$%
  sum(Current_weekly_HH_income_from_government_pensions_and_allowances * Weight_HH_HES) * 52.5

gst.raised.in.200910 <- 46553 * 10^6
# gst.raised.in.200910 / (2*extra_gst_raised)
## [1] 1.631501

welfare.in.200910 <- (110994 - 3831) * 10^6  # total social security + welfare minus admin.
# welfare.in.200910 / welfare.from.hes
## [1] 1.357734

compensatory.transfers <-
  # A quarter of money raised goes to tax cuts and transfers.
  # Transfers = 16 bn, tax cuts = 21 bn (which is over four years 
  # but that is relevant here).
  (1/4)*((16/(16+21))) * extra_gst_raised

proportion_of_welfare_by_quintile <-
  hes10hh %>% 
  group_by(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                         breaks = total.inc.quintiles,  
                                                         include.lowest = TRUE)))) %>%
  summarise(total_welfare = sum(Current_weekly_HH_income_from_government_pensions_and_allowances * Weight_HH_HES),
            extra_gst = sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) / 2) %>%
  ungroup %>%
  mutate(extra_gst.prop = extra_gst / sum(extra_gst),
         prop_welfare = total_welfare/sum(total_welfare),
         implied_transfr = prop_welfare * compensatory.transfers / 52.5,
         comp_adequacy = implied_transfr/extra_gst)
```


## Deloitte double donut
Assuming perfect precision in welfare means testing ('well-targeted payments'), 
```{r, fig.show='hide'}
data.frame(expense = c("Net revenue gain", "Personal tax cuts", "Transfer payments"),
                    number = c(115,21,16)) %>%
  mutate(fraction = number/sum(number)) %>%
  arrange(fraction) %>%
  mutate(ymax = cumsum(fraction),
         ymin = c(0, lag(ymax)[-1])) %>%
  grplot(aes(fill = expense, ymax = ymax, ymin = ymin, xmax = 4, xmin = 3)) + 
  geom_rect(colour = theGrey) + 
  geom_text(aes(x = 4.5, y = 0.5 * (ymin + ymax), label = expense)) +
  coord_polar(theta = "y") + 
  xlim(0,4.6) +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank())
```

```{r, fig.show='hide'}
proportion_of_welfare_by_quintile %>%
  mutate(fraction = extra_gst.prop) %>%
  arrange(fraction) %>%
  mutate(ymax = cumsum(fraction),
         ymin = c(0, lag(ymax)[-1])) %>%
  grplot(aes(fill = Gross_income_quintile, ymax = ymax, ymin = ymin, xmax = 4, xmin = 3)) + 
  geom_rect(colour = theGrey) + 
  geom_text(aes(x = 4.5, y = 0.5 * (ymin + ymax), label = Gross_income_quintile)) +
  coord_polar(theta = "y")+ 
  xlim(0,4.6) +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.line  = element_blank())
```


```{r, fig.height=13, fig.width=13}
outside <- 
  proportion_of_welfare_by_quintile %>%
  mutate(fraction = extra_gst.prop) %>%
  arrange(fraction) %>%
  mutate(ymax = cumsum(fraction),
         ymin = c(0, lag(ymax)[-1]))

inside <- 
  data.frame(expense = c("Net revenue gain", "Personal tax cuts", "Transfer payments"),
                    number = c(115,21,16)) %>%
  mutate(fraction = number/sum(number)) %>%
  arrange(fraction) %>%
  mutate(ymax = cumsum(fraction),
         ymin = c(0, lag(ymax)[-1]))

grplot(NULL) + 
  geom_rect(data = inside, aes(fill = expense, ymax = ymax, ymin = ymin, xmax = 3, xmin = 2)) + 
  geom_rect(data = outside, aes(fill = Gross_income_quintile, ymax = ymax, ymin = ymin, xmax = 4, xmin = 3)) + 
  coord_polar(theta = "y") + 
  xlim(0, 5.5) + 
  geom_text(data = outside, aes(x = 4.5, y = 0.5 * (ymin + ymax), label = Gross_income_quintile),
            fontface = "bold", size = 6, family = "serif")  + 
  geom_text(data = inside, aes(x = 1.5, y = 0.5 * (ymin + ymax), label = expense),
            fontface = "bold", size = 6) +
  theme(panel.grid = element_blank(),
        axis.text = element_blank(),
        axis.ticks = element_blank(),
        axis.title = element_blank(),
        axis.line = element_blank()) + 
  annotate("text",
           x = 0.01, 
           y = 0.01,
           fontface = "bold",
           size = 7,
           label = "Revenue destination") + 
  annotate("text",
           x = 5.15,
           y = 0.01, 
           hjust = 0.5,
           fontface = "bold",
           size = 7,
           family = "serif",
           label = "Revenue origin (household income quintile)")
```

## But this does not paint the full picture
In reality, welfare payments cannot be perfectly targeted -- and certainly not to the bottom household. Past precision is the best performance of future precision, so I analyzed the 2009-10 Housing Expenditure Survey from the ABS to determine how well targeted welfare payments are. 

```{r, echo=TRUE, fig.height = 12, fig.width = 16}
welfare.by.income.quintile <- 
  hes10_indiv %>%
  merge(hes10hh, by = "Unique_household_number", suffixes = c("indiv", "hh")) %>%
  mutate(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                       breaks = total.inc.quintiles,  
                                                       include.lowest = TRUE)))) %>%
  select(Unique_household_number, Gross_income_quintile, 
         Weight_Person_HES, 
         Current_weekly_amount_of_Commonwealth_Rent_Assistance, Current_weekly_income_from_age_pension, Current_weekly_income_from_wife_pension, Current_weekly_income_from_carer_payment, 
         Current_weekly_income_from_carer_allowance, Current_weekly_income_from_special_benefit, Current_weekly_income_from_widow_allowance, Current_weekly_income_from_youth_allowance, Current_weekly_income_from_Austudy_Abstudy, Current_weekly_income_from_parenting_payment, Current_weekly_income_from_Baby_Bonus_payment, Current_weekly_income_from_partner_allowance, Current_weekly_income_from_senior_supplement, Current_weekly_income_from_newstart_allowance, Current_weekly_income_from_pension_supplement, Current_weekly_income_from_sickness_allowance, Current_weekly_income_from_service_pension_DVA, Current_weekly_income_from_utilities_allowance, Current_weekly_income_from_disability_pension_DVA, Current_weekly_income_from_war_widows_pension_DVA, Current_weekly_income_from_disability_support_pension, Current_weekly_income_from_family_tax_benefits_modelled, Current_weekly_income_from_other_government_pensions_and_allowances) %>%
  gather(Allowance, income, -Unique_household_number, -Gross_income_quintile, -Weight_Person_HES) %>%
  data.table %>%
  mutate(Allowance = gsub("Current_weekly_income_from_", "", Allowance, fixed = TRUE)) %>%
  group_by(Gross_income_quintile, Allowance) %>%
  summarise(total = sum(income * Weight_Person_HES)) %>%
  ungroup %>% 
  arrange(desc(total)) 


welfare.by.income.quintile %>%
  mutate(Allowance = factor(Allowance, levels = (welfare.by.income.quintile$Allowance), ordered = TRUE)) %>%
  mutate(text = ifelse(Gross_income_quintile == 2 & total > 1e7, gsub("_", " ", Allowance, fixed = TRUE), NA_character_)) %>%
  group_by(Gross_income_quintile) %>%
  arrange(desc(total)) %>%
  mutate(text.y = cumsum(total)) %>%
  ggplot(aes(x = Gross_income_quintile, fill = Allowance, order = Allowance)) + 
  geom_bar(aes(y = total), stat = "identity", position = "stack") + 
  geom_text(aes(label = text, y = text.y), vjust = 1, fontface = "bold", size = 5.5) + 
  scale_fill_manual(values = c(rep(RColorBrewer::brewer.pal(11, name="Spectral"), 2), "black")) + 
  scale_y_continuous("Weekly total income", label = grattan_dollar) + 
  theme_light(base_size = 18) + 
  theme(legend.position = "none")
```

```{r, results = 'asis'}
proportion_of_welfare_by_quintile.tots <- 
  proportion_of_welfare_by_quintile %>% 
  ungroup %>%
  summarise(Total = sum)

proportion_of_welfare_by_quintile_pretty <- 
  proportion_of_welfare_by_quintile %>%
  arrange(Gross_income_quintile) %>%
  mutate(`Q` = Gross_income_quintile,
         `Total welfare` = grattan_dollar(total_welfare * 52.5),
         `Increased GST burden` = grattan_dollar(extra_gst * 52.5),
         `(%)` = scales::percent(extra_gst.prop),
         `% of total welfare` = scales::percent(prop_welfare),
         `Implied compo` = grattan_dollar(implied_transfr * 52.5),
         `Compo adeq.` = scales::percent(comp_adequacy)) %>%
  select(-contains("_"))

kable(proportion_of_welfare_by_quintile_pretty,
      align = rep("r", ncol(proportion_of_welfare_by_quintile_pretty)))
```



## Household expenditure per week by gross income 
```{r}
final.income.quintiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Weekly_household_final_income_FIS 
              ,.
              #, quantiles = c(0:5)/5)
              ,quantiles = c(0:5)/5
              )

hes10hh %>%
  group_by(
    Gross_income_quintile = factor(as.numeric(cut(Weekly_household_final_income_FIS, 
                                                     breaks = final.income.quintiles,  
                                                     include.lowest = TRUE)))
  ) %>%
  summarise(
    average_total_spending = weighted.mean(Total_household_expenditure_including_selected_other_payments_HES_only, Weight_HH_HES), 
    average_extra_gst = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS, Weight_HH_HES) / 2,
    average_welfare_payments = weighted.mean(Current_weekly_HH_income_from_government_pensions_and_allowances, Weight_HH_HES),
    average_income = weighted.mean(Weekly_household_final_income_FIS, Weight_HH_HES)
  ) %>% 
  arrange(Gross_income_quintile) %>%
  ungroup %>%
  mutate(prop_income_on_extra_gst = average_extra_gst / average_income,
         prop_income_spending = average_total_spending / average_income
         )

hes10hh %>%
  group_by(
    Gross_income_quintile = factor(as.numeric(cut(Weekly_household_final_income_FIS, 
                                                     breaks = final.income.quintiles,  
                                                     include.lowest = TRUE)))
  ) %>%
  mutate(extra_gst = Weekly_household_GST_on_all_goods_and_services_FIS / 2) %$%
  sum(extra_gst * Weight_HH_HES) * 52.5 ->
  extra_gst_raised

compensatory.transfers <-
  ((16/(16+21))/4)*extra_gst_raised   # p. 15 of report

hes10hh %>% 
  mutate(Gross_income_quintile = factor(as.numeric(cut(Weekly_household_final_income_FIS, 
                                                     breaks = final.income.quintiles,  
                                                     include.lowest = TRUE))),
         extra_gst = 52.5 * Weight_HH_HES * Weekly_household_GST_on_all_goods_and_services_FIS / 2,
         compensatory_transfer = ifelse(Gross_income_quintile == 1,
                                        compensatory.transfers / Weight_HH_HES,
                                        0),
         compensation_adequacy = compensatory_transfer / extra_gst) %>%
  group_by(Gross_income_quintile) %>%
  summarise(extra_gst_mean = weighted.mean(extra_gst, Weight_HH_HES),
            compensatory_transfer_mean = weighted.mean(compensatory_transfer, Weight_HH_HES)) %>%
  mutate(compensation_adequacy = compensatory_transfer_mean / extra_gst_mean)

```

```{r}
proportion_of_welfare_by_quintile <-
  hes10hh %>% 
  group_by(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                     breaks = total.inc.quintiles,  
                                                     include.lowest = TRUE)))) %>%
  summarise(total_welfare = sum(Current_weekly_HH_income_from_government_pensions_and_allowances * Weight_HH_HES),
            extra_gst = sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) / 2) %>%
  ungroup %>%
  mutate(prop_welfare = total_welfare/sum(total_welfare),
         implied_transfr = prop_welfare * compensatory.transfers / 52.5,
         comp_adequacy = implied_transfr/extra_gst)
```

## Tax cuts
By inspection of <https://grattan.shinyapps.io/Forty_three_app/Forty_three_app.Rmd> we see that a reduction in the bottom marginal tax rate from 19% to 15.5% results in a $5.6 billion decrease in revenue.

```{r}


```


# Analysis of welfare
```{r}
sih11.raw <- 
  read.dta("./SIH/sih11bp.dta") %>%
  data.table

sih11.names <- 
  hes.sih.vars$SIH_basic_name[hes.sih.vars$SIH_basic_name %in% names(sih11.raw)]
sih11.newnames <-
  hes.sih.vars$Definition_new[hes.sih.vars$SIH_basic_name %in% names(sih11.raw)]

# SIHPSWT didn't come along for the ride
sih11.names <- c(sih11.names, "SIHPSWT")
sih11.newnames <- c(sih11.newnames, "Person_weight")

sih11 <- 
  sih11.raw %>%
  select_(.dots = sih11.names) %>%
  setnames(old = sih11.names,
           new = sih11.newnames)
```

```{r}
sih11 %>%
  mutate(prop_welfare = Total_current_weekly_income_from_government_pensions_and_allowances / Total_current_weekly_income_from_all_sources) %>%
  filter(Total_current_weekly_income_from_all_sources >= 0) %>%
  grplot(aes(x = Total_current_weekly_income_from_all_sources, y = prop_welfare,
             alpha = Person_weight/max(Person_weight), weight = Person_weight)) + 
  geom_point() +
  scale_alpha_identity() + 
  scale_y_continuous("% income from welfare", 
                     label = scales::percent) + 
  coord_cartesian(xlim = c(-25,4.2e3),
                  ylim = c(-0.1,1.25)) +
  theme(axis.title.y = element_text(angle = 90))
```

```{r}
sih11 %>%
  mutate(prop_welfare = Total_current_weekly_income_from_government_pensions_and_allowances / Total_current_weekly_income_from_all_sources) %>%
  mutate(has_age_pnsn = ifelse(Current_weekly_income_from_age_pension > 0, 
                               "Age pension", 
                               "No age pension"),
         has_fmly_bnft = Current_weekly_income_from_parenting_payment > 0,
         has_dsably = Current_weekly_income_from_disability_support_pension > 0,
         has_newstart = Current_weekly_income_from_newstart_allowance > 0,
         has_snrsupplment = ifelse(Current_weekly_income_from_senior_supplement > 0,
                                   "Those with senior supplement",
                                   "Those with no senior supplement")) %>%
  filter(Total_current_weekly_income_from_all_sources >= 0) %>%
  grplot(aes(x = Total_current_weekly_income_from_all_sources, y = prop_welfare,
             color = has_snrsupplment, order = has_snrsupplment,
             alpha = Person_weight/max(Person_weight), weight = Person_weight)) + 
  geom_point() +
  scale_alpha_identity() + 
  scale_color_manual(values = c("Those with senior supplement" = gpal(2)[1], "Those with no senior supplement" = gpal(2)[2])) +
  guides(color = guide_legend("", override.aes = list(size = 8))) + 
  scale_y_continuous("% income from welfare", 
                     label = scales::percent) + 
  coord_cartesian(xlim = c(-25,4.2e3),
                  ylim = c(-0.1,1.25)) +
  xlab("Total weekly income") + 
  theme(axis.title.y = element_text(angle = 90),
        legend.position = c(0.7,0.85),
        text = element_text(color = "white"),
        line = element_line(color = "white"),
        axis.line = element_line(color = "white"),
        panel.grid.major.y = element_blank(),
        axis.ticks = element_line(color = "white"),
        plot.background = element_rect(fill = theGrey),
        legend.key = element_rect(color = NA, fill=theGrey),
        legend.text = element_text(lineheight = 0.7))
```

```{r}
sih11 %>%
  mutate(prop_welfare = Total_current_weekly_income_from_government_pensions_and_allowances / Total_current_weekly_income_from_all_sources) %>%
  mutate(has_age_pnsn = ifelse(Current_weekly_income_from_age_pension > 0, 
                               "Age pensioners", 
                               "No age pension"),
         has_fmly_bnft = Current_weekly_income_from_parenting_payment > 0,
         has_dsably = Current_weekly_income_from_disability_support_pension > 0,
         has_newstart = Current_weekly_income_from_newstart_allowance > 0,
         has_snrsupplment = ifelse(Current_weekly_income_from_senior_supplement > 0,
                                   "Senior supplement > 0",
                                   "No senior supplement")) %>%
  filter(Total_current_weekly_income_from_all_sources >= 0,
         Current_weekly_income_from_age_pension > 0) %>%
  grplot(aes(x = Total_current_weekly_income_from_all_sources, y = prop_welfare,
             color = has_age_pnsn, order = has_age_pnsn,
             alpha = Person_weight/max(Person_weight), weight = Person_weight)) + 
  geom_point() +
  scale_alpha_identity() + 
  scale_color_manual(values = c("Age pensioners" = gpal(2)[1], "No age pension" = gpal(2)[2])) +
  guides(color = guide_legend("", override.aes = list(size = 8))) + 
  scale_y_continuous("% income from welfare", 
                     label = scales::percent) + 
  coord_cartesian(xlim = c(-25,4.2e3),
                  ylim = c(-0.1,1.25)) +
  xlab("Total weekly income") + 
  theme(axis.title.y = element_text(angle = 90),
        legend.position = c(0.7,0.85),
        text = element_text(color = "white"),
        line = element_line(color = "white"),
        axis.line = element_line(color = "white"),
        panel.grid.major.y = element_blank(),
        axis.ticks = element_line(color = "white"),
        plot.background = element_rect(fill = theGrey),
        legend.key = element_rect(color = NA, fill=theGrey))
```

## What magnitude of compensation would be required in order for the lowest 20% disposable income would be compensated?

### 15% increase

```{r}
extra_gst.weekly <- 
  hes10hh %$%
  sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) / 2

temp.chessboard <- 
  data.table::CJ(
    Unique_household_number = hes10hh$Unique_household_number,
    percentage_revenue = (0:100)/100,
    comp_adequacy = (1:7)/4
  )

temp.chessboard.2 <- 
  data.table::CJ(
    Unique_household_number = hes10hh$Unique_household_number,
    percentage_revenue = (0:100)/100
  )

perfectly_targeted_efficacy.15pc <- 
  hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS,
         Total_current_weekly_HH_income_from_all_sources,
         Weight_HH_HES
         ,Unique_household_number
  ) %>% 
  merge(., temp.chessboard.2, by = "Unique_household_number", all.y = TRUE) %>%
  group_by.income_quintile %>%
  ungroup %>%
  data.table %>% 
  mutate(revenue_for_transfer = percentage_revenue * extra_gst.weekly) %>%
  group_by(percentage_revenue) %>%
  mutate(revenue_transfered = ifelse(income_quintile == 1,  # may be redundant but not sure
                                     # We multiply by 5 because all the money is transferred to the bottom
                                     # quintile.  I can't at this time convince myself why this 
                                     # multiple is necessary -- except the numbers don't look right
                                     # without it.  In particular, even if all money is transferred to the
                                     # bottom quintile, a large minority of households are undercompensated.
                                     (five <- 5) * revenue_for_transfer/sum(Weight_HH_HES), 
                                     0)) %>%
  data.table %>%
  filter(income_quintile == 1) %>% 
  group_by(percentage_revenue) %>%
  summarise(
    percentage_compensated = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS/2 < revenue_transfered,
                                           w = Weight_HH_HES))

perfectly_targeted_efficacy_comp_adequacy.15pc <- 
  hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS,
         Total_current_weekly_HH_income_from_all_sources,
         Weight_HH_HES
         ,Unique_household_number
  ) %>% 
  merge(., temp.chessboard, by = "Unique_household_number", all.y = TRUE) %>%
  group_by.income_quintile %>%
  ungroup %>%
  data.table %>% 
  mutate(revenue_for_transfer = percentage_revenue * extra_gst.weekly) %>%
  group_by(percentage_revenue, comp_adequacy) %>%
  mutate(revenue_transfered = ifelse(income_quintile == 1,  # may be redundant but not sure
                                     # We multiply by 5 because all the money is transferred to the bottom
                                     # quintile.  I can't at this time convince myself why this 
                                     # multiple is necessary -- except the numbers don't look right
                                     # without it.  In particular, even if all money is transferred to the
                                     # bottom quintile, a large minority of households are undercompensated.
                                     (five <- 5) * revenue_for_transfer/sum(Weight_HH_HES), 
                                     0)) %>%
  data.table %>%
  filter(income_quintile == 1) %>% 
  group_by(percentage_revenue, comp_adequacy) %>%
  summarise(
    percentage_compensated = weighted.mean(comp_adequacy * Weekly_household_GST_on_all_goods_and_services_FIS/2 < revenue_transfered,
                                           w = Weight_HH_HES))
gc(1,1)
```

```{r}
proportion_of_welfare_bottom_quintile <- 
  proportion_of_welfare_by_quintile %>%
  filter(Gross_income_quintile == 1) %$%
  prop_welfare

ordinarily_targeted_efficacy.15pc <- 
  hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS,
         Total_current_weekly_HH_income_from_all_sources,
         Weight_HH_HES
         ,Unique_household_number
  ) %>%
  merge(., temp.chessboard.2, by = "Unique_household_number", all.y = TRUE) %>%
  group_by.income_quintile %>%
  ungroup %>%
  data.table %>% 
  mutate(revenue_for_transfer = percentage_revenue * extra_gst.weekly) %>%
  group_by(percentage_revenue) %>%
  mutate(revenue_transfered = revenue_for_transfer/sum(Weight_HH_HES)) %>% 
  # Recalling that only a fraction of welfare actually goes to the bottom quintile:
  merge(., proportion_of_welfare_by_quintile, by.x = "income_quintile", by.y = "Gross_income_quintile") %>%
  mutate(revenue_transfered = prop_welfare * revenue_transfered) %>%
  data.table %>% 
  filter(income_quintile == 1) %>% 
  group_by(percentage_revenue) %>%
  summarise(
    percentage_compensated = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS/2 < revenue_transfered,
                                           w = Weight_HH_HES))

ordinarily_targeted_efficacy_comp_adequacy.15pc <- 
  hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS,
         Total_current_weekly_HH_income_from_all_sources,
         Weight_HH_HES
         ,Unique_household_number
  ) %>%
  merge(., temp.chessboard, by = "Unique_household_number", all.y = TRUE) %>%
  group_by.income_quintile %>%
  ungroup %>%
  data.table %>% 
  mutate(revenue_for_transfer = percentage_revenue * extra_gst.weekly) %>%
  group_by(percentage_revenue, comp_adequacy) %>%
  mutate(revenue_transfered = ifelse(income_quintile == 1,  # may be redundant but not sure
                                     # We multiply by 5 because all the money is transferred to the bottom
                                     # quintile.  I can't at this time convince myself why this 
                                     # multiple is necessary -- except the numbers don't look right
                                     # without it.  In particular, even if all money is transferred to the
                                     # bottom quintile, a large minority of households are undercompensated.
                                     (five <- 5) * revenue_for_transfer/sum(Weight_HH_HES), 
                                     0)) %>%
  # Recalling that only a fraction of welfare actually goes to the bottom quintile:
  mutate(revenue_transfered = proportion_of_welfare_bottom_quintile * revenue_transfered) %>%
  data.table %>%
  group_by(percentage_revenue, comp_adequacy) %>%
  summarise(
    percentage_compensated = weighted.mean(comp_adequacy * Weekly_household_GST_on_all_goods_and_services_FIS/2 < revenue_transfered,
                                           w = Weight_HH_HES))
```

```{r}
perfect_and_imperfect <- 
  bind_rows(ordinarily_targeted_efficacy.15pc, perfectly_targeted_efficacy.15pc, .id = "targeting")

perfect_and_imperfect %>%
  grplot(aes(x = percentage_revenue, y = percentage_compensated, color = targeting, group = targeting)) + 
  geom_line() + 
  theme(axis.title.y = element_text(angle = 90)) + 
  scale_x_continuous("Percentage of total GST revenue required", label=scales::percent) + 
  scale_y_continuous("Percentage of bottom quintile fully compensated\n", label=scales::percent) + 
  annotate("text",
           x = c(0.07, 0.35),
           y = c(0.95, 0.6), 
           label = c("Perfect", "BAU"),
           color = rev(gpal(2)),
           fontface = "bold",
           size = 7) + 
  annotate("point",
           x = 0.2,
           y = ordinarily_targeted_efficacy.15pc[ordinarily_targeted_efficacy.15pc$percentage_revenue == 0.2]$percentage_compensated,
           size = 7,
           color = theGrey)
```

```{r, fig.height = 16, fig.width = 14}
perfect_and_imperfect_comp_adequacy <- 
  bind_rows(ordinarily_targeted_efficacy_comp_adequacy.15pc, perfectly_targeted_efficacy_comp_adequacy.15pc, .id = "targeting") %>%
  mutate(targeting = ifelse(targeting == 1, "BAU", "Perfect"))

text_facet <- 
  data.frame(targeting = factor(c("BAU", "Perfect")),
             percentage_revenue = c(0.07, 0.35), 
             percentage_compensated = c(1.05, 0.6),
             comp_adequacy = c(0,0),
             alpha = c(0,0),
             size = c(0,0),
             linetype = c("A", "B"))

text_facet.bau <-
  data.frame(targeting = factor("BAU", levels =  c("BAU", "Perfect")),
             percentage_revenue = c(0.07), 
             percentage_compensated = c(1.05),
             comp_adequacy = c(0),
             alpha = c(0),
             size = c(0),
             linetype = c("A"))

text_facet.perf <-
  filter(text_facet, targeting == "Perfect")

perfect_and_imperfect_comp_adequacy %>%
  mutate(alpha = ifelse(comp_adequacy == 1, 1, 1),
         size  = ifelse(comp_adequacy == 1, 2.5, 1.025),
         linetype = ifelse(comp_adequacy == 1, "A", "A")) %>%
  grplot(aes(x = percentage_revenue, y = percentage_compensated, color = targeting, group = interaction(targeting, comp_adequacy), alpha = alpha, size = size, linetype = linetype)) + 
  geom_line() + 
  theme(axis.title.y = element_text(angle = 90)) + 
  scale_x_continuous("Percentage of total GST revenue required", label=scales::percent) + 
  scale_y_continuous("Percentage of bottom quintile compensated by 25\\%, 50\\%, ... 175\\%\n", label=scales::percent) + 
  scale_alpha_identity() + 
  scale_size_identity() +
  geom_text(data = text_facet.bau,
            label = "BAU") +
  geom_text(data = text_facet.perf,
            label = "Perfect") + 
  theme(panel.margin = unit(2, "lines")) +
  facet_grid(targeting ~ .)

```

# Constant 20% revenue --
x
```{r}
temp.chessboard <- 
  data.table::CJ(
    comp_adequacy = (0:200)/100,
    Unique_household_number = hes10hh$Unique_household_number
  )

percentage_revenue_ <- 0.30

perfect_20pc_comp_adequacy.15pc <-
  hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS,
         Total_current_weekly_HH_income_from_all_sources,
         Weight_HH_HES
         ,Unique_household_number
  ) %>%
  merge(., temp.chessboard, by = "Unique_household_number", all.y = TRUE) %>%
  group_by.income_quintile %>%
  ungroup %>%
  data.table %>% 
  mutate(revenue_for_transfer = percentage_revenue_ * extra_gst.weekly) %>%
  group_by(comp_adequacy) %>%
  mutate(revenue_transfered = ifelse(income_quintile == 1,  # may be redundant but not sure
                                     # We multiply by 5 because all the money is transferred to the bottom
                                     # quintile.  I can't at this time convince myself why this 
                                     # multiple is necessary -- except the numbers don't look right
                                     # without it.  In particular, even if all money is transferred to the
                                     # bottom quintile, a large minority of households are undercompensated.
                                     (five <- 5) * revenue_for_transfer/sum(Weight_HH_HES), 
                                     0)) %>%
  data.table %>%
  filter(income_quintile == 1) %>% 
  group_by(comp_adequacy) %>%
  summarise(
    percentage_compensated = weighted.mean(comp_adequacy * Weekly_household_GST_on_all_goods_and_services_FIS/2 < revenue_transfered,
                                           w = Weight_HH_HES)) 

ordinary_20pc_comp_adequacy.15pc <-
  hes10hh %>%
  select(Weekly_household_GST_on_all_goods_and_services_FIS,
         Total_current_weekly_HH_income_from_all_sources,
         Weight_HH_HES
         ,Unique_household_number
  ) %>%
  merge(., temp.chessboard, by = "Unique_household_number", all.y = TRUE) %>%
  group_by.income_quintile %>%
  ungroup %>%
  data.table %>% 
  # Note trailing underscore for percentage_revenue_
  mutate(revenue_for_transfer = percentage_revenue_ * extra_gst.weekly) %>%
  group_by(comp_adequacy) %>%
  mutate(revenue_transfered = ifelse(income_quintile == 1,  # may be redundant but not sure
                                     # We multiply by 5 because all the money is transferred to the bottom
                                     # quintile.  I can't at this time convince myself why this 
                                     # multiple is necessary -- except the numbers don't look right
                                     # without it.  In particular, even if all money is transferred to the
                                     # bottom quintile, a large minority of households are undercompensated.
                                     (five <- 5) * revenue_for_transfer/sum(Weight_HH_HES), 
                                     0)) %>%
  # Recalling that only a fraction of welfare actually goes to the bottom quintile:
  mutate(revenue_transfered = proportion_of_welfare_bottom_quintile * revenue_transfered) %>%
  data.table %>%
  filter(income_quintile == 1) %>% 
  group_by(comp_adequacy) %>%
  summarise(
    percentage_compensated = weighted.mean(comp_adequacy * Weekly_household_GST_on_all_goods_and_services_FIS/2 < revenue_transfered,
                                           w = Weight_HH_HES)) 
```
For 30% revenue
```{r}
perfect_and_imperfect.comp_adequacy.15pc <- 
  bind_rows(perfect_20pc_comp_adequacy.15pc, ordinary_20pc_comp_adequacy.15pc, .id = "targeting") %>%
  mutate(targeting = ifelse(targeting == 1, "Perfect", "BAU")) %>%
  mutate(targeting.text = ifelse(comp_adequacy == 1, targeting, NA_character_))

perfect_and_imperfect.comp_adequacy.15pc %>%
  grplot(aes(x = comp_adequacy, y = percentage_compensated, group = targeting, color = targeting)) + 
  geom_line() + 
  geom_text(aes(label = targeting.text), vjust = 1.5, hjust = 1,
            fontface = "bold", size =7) + 
  scale_x_continuous("Compensation threshold/Increased GST burden", label = scales::percent) + 
  scale_y_continuous("Percentage of bottom quintile meeting threshold", limits = c(0,1), label = scales::percent) + 
  theme(axis.title.y = element_text(angle = 90))
```

## Column chart:
```{r}
compensation_board <- 
  data.table::CJ(
    comp_adequacy = c(0.75, 1, 1.25),
    Unique_household_number = hes10hh$Unique_household_number
  )



extra_gst_total <- 
  hes10hh %$%
  sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) / 2

compensation.package <- 0.3 * extra_gst_total

hes10hh %>%
  merge(., compensation_board, by = "Unique_household_number") %>%
  group_by.income_quintile %>% ungroup %>%
  merge(., dplyr::select(proportion_of_welfare_by_quintile, -comp_adequacy), by.x = "income_quintile", by.y = "Gross_income_quintile") %>%   data.table %>%
  group_by(comp_adequacy) %>%
  mutate(welfare_transfered = extra_gst_total * prop_welfare * Weight_HH_HES / sum(Weight_HH_HES)) %>%
  tbl_df %>%
  select(Unique_household_number, comp_adequacy, welfare_transfered, Weekly_household_GST_on_all_goods_and_services_FIS)
  
  
```

## Compensation
You would have to spend x much on compensation to fully compensate the bottom quintile. Note that this would also partially compensate other quintiles.  Use the Weekly GST amount to work out the proportion of the GST burden falling on the bottom three quintiles, subtract off what has already been allocated by transfers. Then have a cameo income tax reduction to determine the income tax cuts available.


```{r}
gst_revenue.15pc.weekly <- 
  hes10hh %$%
  sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES)/2

ratio.gst_welfare <- 0.30

welfare.by.income.quintile_total <-
  welfare.by.income.quintile %>%
  group_by(income_quintile = Gross_income_quintile) %>%
  summarise(total = sum(total)) %>%
  ungroup %>%
  mutate(prop_welfare = total/sum(total)) %>%
  select(-total)


inverse = function (f, lower = -100, upper = 100000) {
   function (y) uniroot((function (x) f(x) - y), lower = lower, upper = upper)[[1]]
}

inverse_income_tax.fn <- function(tax){
  inverse(f = function(income)income_tax(income))(tax)[[1]]
}

new_inverse <- function(tax){
  for (i in seq.int(from=10e3, to=500e3, by = 100)){
    if (income_tax(i, fy.year = "2009-10") > tax){
      
      break()
    }
  }
  return(i)
}



gst_third.inc.quintile_deciles <-  
  hes10hh  %>%
  group_by.income_quintile %>%
  ungroup %>%
  filter(income_quintile == 3) %>%
  data.table %>%
  svydesign(data = ., weights = ~Weight_HH_HES, ids = ~Unique_household_number) %>%
  svyquantile(design = ., quantiles = c(0:100)/100, ~Weekly_household_GST_on_all_goods_and_services_FIS)

gst_by_income.2 <- 
  hes10hh %>%
  tbl_df %>%
  group_by.income_quintile %>%
  # 0.5 because 5pcpt increase
  summarise(gst_burden = 0.5 * sum(Weekly_household_GST_on_all_goods_and_services_FIS*Weight_HH_HES),
            gst_burden_weekly = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS, Weight_HH_HES),
            income.tax = 52.5*weighted.mean(Household_weekly_expenditure_on_income_tax_HES_only, Weight_HH_HES),
            taxable_income = new_inverse(pmax(0,income.tax)),
            Weight_HH_HES = sum(Weight_HH_HES)
            ) %>%
  arrange(income_quintile) %>%
  mutate(prop_burden = gst_burden/sum(gst_burden)) %>%
  merge(welfare.by.income.quintile_total, by = "income_quintile") %>%
  ungroup %>%
  mutate(comp_trsfr = prop_welfare * ratio.gst_welfare * gst_revenue.15pc.weekly,
         gst_burden_after_transfer = gst_burden - comp_trsfr,
         gst_burden_after_transfer.annual = (gst_burden_after_transfer / ((1/5)*sum(Weight_HH_HES)))  * 52.5) %>%
  ## Conversion to 2012-13:
  mutate(gst_burden_after_transfer.annual.201213 = gst_burden_after_transfer.annual * GST_inflator_from0910_to1213) 

ratio.gst.burden.80th.percentile.to.average_third.decile <-
  gst_third.inc.quintile_deciles[99]/gst_by_income.2[gst_by_income.2$income_quintile == 3,]$gst_burden_weekly

gst_by_income.2 %<>%
  mutate(gst_burden_after_transfer.annual.201213.decile8 = gst_burden_after_transfer.annual.201213 * ratio.gst.burden.80th.percentile.to.average_third.decile)

gst_by_income.2 %>%
  kable
```

```{r}
sample_file_of <- function(year = 2013){
  year <- min(2013, year)
  fy.year <- paste0(year - 1, "-", formatC(year - 2000, flag = "0", width=2))
  # List all files with sample in them that have csv or txt at the end.
  list.of.files <- list.files(path = "./IndividualSampleFile", pattern = paste0("(s|S)ample.*((csv)|(txt))$"), recursive = TRUE, full.names = TRUE)
  return(list.of.files[grepl(fy.year, list.of.files)])
}


get_sample_file <- function(year = 2013){
  colClasses = sapply(fread(sample_file_of(year), nrows=50), class)
  fread(sample_file_of(year), colClasses = colClasses, na.strings = "?")
}

get_sample_file(2013) %>%
  group_by(income_quintile = ntile(Tot_inc_amt, 5)) %>%
  summarise(mean.income = mean(Tot_inc_amt),
            mean.tx.income = mean(Taxable_Income),
            max. = max(Taxable_Income)) %>%
  arrange(income_quintile)
```


```{r}
gst_201213 <- 
  hes10hh %>% 
  group_by.income_quintile() %>% 
  summarise(mean. = weighted.mean(Total_current_weekly_HH_income_from_all_sources_basis, Weight_HH_HES)*52.5, 
            max. = max(Total_current_weekly_HH_income_from_all_sources)*52.5) %>% 
  ungroup %>% 
  arrange(income_quintile) %>%
  mutate(max.1213 = wage_inflator(max., from_fy = "2009-10", to_fy = "2012-13")) %>%
  merge(gst_by_income.2, by = "income_quintile")

kable(gst_201213)
```
So the maximum household income of a household in the third income quintile is $93,724 who required (assuming they were at the 80th percentile of the distribution by GST burden) a compensation package of $1325 . Assuming that this is a single person household, by inspection, a reduction in the marginal rates from 19% to 17.5% and from 32.5% to 30% would result in income compensation of $1357, at a cost of over $7 billion. For a two-person household, in which two-thirds of the income is earnt by one of the couple, marginal rates of 16.5% and 29.5% would result in an adequate compensation package of $1416, at a cost of $9.6 billion.

```{r}
gst_by_income.2 %>%
  select(income_quintile,
         comp_trsfr,
         gst_burden_after_transfer.annual,
         gst_burden_after_transfer.annual.201213)

GST_by_year.actual <- 
  GST_inflator_from0910_to1314 <-
  read_excel("GST_by_year.xlsx", sheet = "GST Table 1", skip = 2) %>%
  setnames(1:2, c("Selected_item", "unit")) %>% 
  # en dash caution
  setnames(old = names(.), new = gsub("([0-9]{4}).([0-9]{2})", "\\1-\\2", names(.))) %>%
  gather(year, value, `2001-02`:`2013-14`) %>%
  mutate(value = as.numeric(value)) %>%
  filter(complete.cases(.)) %>%
  filter(grepl("Net.GST", Selected_item)) %>%
  filter(grepl("^((2009)|(2012)|(2013))", year))

GST_by_year.hes <- 
  hes10hh %$%
  sum(Weekly_household_GST_on_all_goods_and_services_FIS * Weight_HH_HES) * 52.5/1e6

# GST_comparison_hes_vs_actual 

```

```{r}
percentage_of_revenue_to_transfers <- 0.3

# gst_revenue.15pc.weekly

hes_with_gst_compensation <- 
  hes10hh %>%
  group_by.income_quintile() %>%
  ungroup %>%
  data.table %>%
  setkey(income_quintile) %>%
  merge(., welfare.by.income.quintile_total) %>%
  group_by(income_quintile) %>%
  mutate(
    new_welfare = gst_revenue.15pc.weekly * percentage_of_revenue_to_transfers *
      prop_welfare / # amount to all households in that quintile
      sum(Weight_HH_HES)
  ) %>%
  group_by(income_quintile) %>%
  summarise(comp_adequacy.75pc = weighted.mean(new_welfare > 0.75* Weekly_household_GST_on_all_goods_and_services_FIS/2, Weight_HH_HES),
            comp_adequacy.100pc = weighted.mean(new_welfare > Weekly_household_GST_on_all_goods_and_services_FIS/2, Weight_HH_HES),
            comp_adequacy.125pc = weighted.mean(new_welfare > 1.25*Weekly_household_GST_on_all_goods_and_services_FIS/2, Weight_HH_HES)
  ) %T>%
  readr::write_csv(path = "./figure/GST_compensation_by_quintile_and_threshold.csv") %>%
  gather(threshold, comp_adequacy, comp_adequacy.75pc:comp_adequacy.125pc) %>%
  mutate(threshold = gsub("pc", "%", 
                          gsub("^.*\\.", "", threshold)),
         threshold = factor(threshold, levels = c("75%", "100%", "125%")))
```

```{r}
hes_with_gst_compensation %T>%
  chart_data() %>%
  grplot(aes(x = income_quintile, fill = threshold, y = comp_adequacy)) + 
  geom_bar(stat = "identity",
           position = "dodge") + 
  scale_y_continuous("Percent reaching threshold", label=percent,
                     limits = c(0,1)) + 
  guides(fill = guide_legend("Threshold of adeq.\ncompensation")) + 
  theme(legend.position = c(0.7,0.7),
        axis.title.y = element_text(angle = 90))
  
```

## Calculating the effect of the increase with the taper rate

```{r}
IND <- function(x, min, max = Inf){
  as.numeric(x >= min) * as.numeric(x < max)
}

dgp <- function(x, beta0, beta1, beta2, noise = TRUE){
  beta0 * IND(x, min = 0, max = beta1) + (beta0 / (beta2 - beta1))*(beta2 - x) * IND(x, min = beta1, max = beta2) + 
    ifelse(noise, rnorm(length(x), mean = 0, sd = beta0/4), 0)
}

grplot(sih11,
       aes(Total_current_weekly_income_from_all_sources - Total_current_weekly_income_from_government_pensions_and_allowances,
           Total_current_weekly_income_from_government_pensions_and_allowances)) + 
  geom_point(aes(alpha = Person_weight/max(Person_weight))) +
  scale_alpha_identity() + 
  scale_x_continuous("Income not from welfare",
                     limits = c(0,3000),
                     label=grattan_dollar) + 
  scale_y_continuous("Welfare",
                     label=grattan_dollar) + 
  coord_equal() + 
  stat_smooth() + 
  annotate("point",
           color = col.6,
           x = 0:1200,
           y = dgp(x = 0:1200, beta0 = 250, beta1 = 300, beta2 = 700, noise = FALSE))
```

```{r}


Y <- dgp(xx <- seq(-1,10, by = 0.01), beta0 = 1, beta1 = 2, beta2 = 3)
# nls(Y ~ beta0 * IND(xx, 0, beta1) + (beta0 / (beta2 - beta1)) * (beta2 - xx) * IND(xx, beta1, beta2), start = list(beta0=1.5, beta1=2.3, beta2=4))
```

```{r, eval=FALSE}
y <- filter(sih11, Total_current_weekly_income_from_all_sources > 0) %$% {Total_current_weekly_income_from_government_pensions_and_allowances - 1}
x <- filter(sih11, Total_current_weekly_income_from_all_sources > 0) %$% 
{Total_current_weekly_income_from_all_sources - Total_current_weekly_income_from_government_pensions_and_allowances}

#boo
nlsLM(y ~ beta0 * IND(x, 0, beta1) + (beta0 / (beta2 - beta1)) * (beta2 - x) * IND(x, beta1, beta2),
    start = list(beta0 = 250,  # pars based off plot
                 beta1 = 301.2,
                 beta2 = 800.7),
    control = nls.lm.control(maxiter = 1000) #
    )
```

```{r}
sih11 %>%
  filter(Current_weekly_income_from_newstart_allowance > 0) %>%
  grplot(aes(y = Current_weekly_income_from_newstart_allowance,
             x = Total_current_weekly_income_from_all_sources - Current_weekly_income_from_newstart_allowance)) + 
  geom_point(aes(alpha = Person_weight/max(Person_weight))) + 
  scale_alpha_identity() + 
  ylim(0, max(sih11$Current_weekly_income_from_newstart_allowance)*1.5) + 
  xlim(0,1500)+
  stat_smooth() + 
  xlab("Income less newstart")
```

## Number of people coming onto the age pension (2012-13)
```{r}
current_full_pension <- 
  675.20 * 26  # 2012-13
  # 788.4*26  ## 2014-15
age_pension_cutoff <- 
  1840 * 26   ## 2012-13
  # 1896*26   ## 2014-15

welfare_inflator <- 1 +
  0.3 *  # prop of extra revenue to transfers
  (48499 / # GST
           2 / # extra 5 pc
           140569  # welfare spend   ### (all 2013-14)
         )

new_age_pension_cutoff <- age_pension_cutoff * welfare_inflator  # similar triangles

age_pension_by_household <- 
  hes10_indiv %>%
  group_by(Unique_household_number) %>%
  summarise(total_age_pension = sum(Current_weekly_income_from_age_pension))

age_pension_by_household %>%
  merge(dplyr::select(hes10hh, 
                      Unique_household_number,
                      Current_weekly_HH_income_from_government_pensions_and_allowances),
        by = "Unique_household_number") %>%
  filter(Current_weekly_HH_income_from_government_pensions_and_allowances > 0)  %$%
  weighted.mean(total_age_pension / Current_weekly_HH_income_from_government_pensions_and_allowances)

age_mutate_ <- function(.data){
  .data %>%
  mutate(Age = car::recode(age_range, "0 = '70 and over';
                            1 = '65 to 69';
                            2 = '60 to 64';
                            3 = '55 to 59';
                            4 = '50 to 54';
                            5 = '45 to 49';
                            6 = '40 to 44';
                            7 = '35 to 39';
                            8 = '30 to 34';
                            9 = '25 to 29';
                            10 = '20 to 24';
                            11 = 'under 20'")) %>%
  mutate(Age =  factor(Age,
                       levels = c("under 20",
                                  '20 to 24',
                                  '25 to 29',
                                  '30 to 34',
                                  '35 to 39',
                                  '40 to 44',
                                  '45 to 49',
                                  '50 to 54',
                                  '55 to 59',
                                  '60 to 64',
                                  '65 to 69',
                                  '70 and over'),
                       labels = gsub("\\s", "\n",
                                     c("under 20",
                                       '20 to 24',
                                       '25 to 29',
                                       '30 to 34',
                                       '35 to 39',
                                       '40 to 44',
                                       '45 to 49',
                                       '50 to 54',
                                       '55 to 59',
                                       '60 to 64',
                                       '65 to 69',
                                       '70 and over')),
                       ordered = T))
}

get_sample_file() %>%
  age_mutate_ %>%
  #filter(Age %in% c("55 to 59", "60 to 64", "65 to 69", "70 and over")) %$%
  tbl_df %>%
  group_by(Age) %>%
  summarise(Age_pension_entrants = sum(Tot_inc_amt >= age_pension_cutoff & Tot_inc_amt <= new_age_pension_cutoff) * 50 / 1e6) %>%
  grplot(aes(x = Age, y = Age_pension_entrants)) + 
  geom_bar(stat = "identity")
```

```{r}

current_full_pension <- 
  675.20 * 26  # 2012-13
  # 788.4*26  ## 2014-15
age_pension_cutoff <- 
  1840 * 26   ## 2012-13
  # 1896*26   ## 2014-15
allowance <- 
  12807.60  # http://www.cpaaustralia.com.au/~/media/corporate/allfiles/document/professional-resources/financial-planning/tax-social-security-guide-2012-13.pdf

allowance_with_income <- 
  function(fortnightly.income){
    fortnightly.income + max(0, 492.6 - (0.5 * (fortnightly.income - 62) * IND(fortnightly.income, min = 62, max = 250) +
                                     IND(fortnightly.income, min = 250) * 0.6 * (fortnightly.income - 250)))
  }

for (i in 492:2000){
  if (allowance_with_income(i) == i){
    allowance_cutoff_fortnightly <- i
    break
  }
}

allowance_cutoff <- 
  allowance_cutoff_fortnightly * 26

get_sample_file() %$% sum()

  
```



## Absolute impacts
Amount spent per quintile:
```{r}
hes10hh %>% 
  group_by.income_quintile %>%
  summarise(mean_spend = weighted.mean(Total_goods_and_services_expenditure_HES_only, Weight_HH_HES),
            mean_gst = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS, Weight_HH_HES),
            mean_extra_gst = weighted.mean(Weekly_household_GST_on_all_goods_and_services_FIS/2, Weight_HH_HES)) %>%
  mutate(mean_extra_gst/mean_spend)
```




# Our tax cuts

```{r}
hes10_indiv.orig <- hes10_indiv
hes10_indiv %<>%
  mutate(taxable_income = inverse_income(52 * Imputed_current_weekly_tax_payable, fy.year = "2009-10", zero.tax.income = "uniform")) 

hes10_indiv %>% select(Imputed_current_weekly_tax_payable, taxable_income) %>% head(30)

actual_taxable_incomes <- get_sample_file(year = 2009) %$% Taxable_Income
```

```{r}
new_income_tax <- 
  function(income, input){
      LITO <- ifelse(income < input$bracket_2, 445, 
                     ifelse(income < 66667, 445 - ((income - input$bracket_2) * 0.015), 0))
      tax <- ifelse(income < input$bracket_1, 0, 
                    ifelse(income < input$bracket_2, 
                           txmr(input$bracket_1) * (income - input$bracket_1), # from 0.19
                           ifelse(income < input$bracket_3,
                                  txamt(input$bracket_2) + txmr(input$bracket_2) * (income - input$bracket_2), # from 0.325
                                  ifelse(income < input$bracket_4,
                                         txamt(input$bracket_3) + txmr(input$bracket_3) * (income - input$bracket_3), # from 0.37
                                         txamt(input$bracket_4) + txmr(input$bracket_4) * (income - input$bracket_4)))))
      medicare.levy <- ifelse(income <= ML.lower, 0, 
                              ifelse(income > ML.lower & income <= ML.upper, 
                                     0.1 * (income - 20542), 
                                     0.015 * income))
      out <- pmax(tax + medicare.levy - LITO, 0)
      return(out)
    }


```

```{r}
new_income_tax_outer0910 <- function(income0910, brackets = c(6000, 35000, 80000, 180000), rates = c(0, 0.15, 0.30, 0.38, 0.45)){
  input <- 
    list(
      bracket_1 = brackets[1],
      bracket_2 = brackets[2],
      bracket_3 = brackets[3],
      bracket_4 = brackets[4],
      #
      rate_1 = rates[1],
      rate_2 = rates[2],
      rate_3 = rates[3],
      rate_4 = rates[4],
      rate_5 = rates[5]
    )
  
  tax_rates <- 
    data.table(
      brackets = c(0, input$bracket_1, input$bracket_2, input$bracket_3, input$bracket_4),
      rates = c(input$rate_1, 
                input$rate_2,
                input$rate_3,
                input$rate_4,
                input$rate_5)
    ) %>%
    mutate(
      tax_amount = NA_real_
    )
  
  for (i in 1:nrow(tax_rates)){
    if (i == 1 || i == 2) {
      tax_rates$tax_amount <- 0
    } else {
      tax_rates$tax_amount[i] <-
        tax_rates$tax_amount[i - 1] + 
        tax_rates$rates[i - 1] * (tax_rates$brackets[i] - tax_rates$brackets[i - 1]) 
    }
    
  }
  
  txamt <- function(bracket.lwr){
    tax_rates %>%
      filter(brackets == bracket.lwr) %$%
      tax_amount
  }
  
  txmr <- function(bracket.lwr){
    tax_rates %>% 
      filter(brackets == bracket.lwr) %$%
      rates
  }
  
  new_income_tax <- function(income){
    LITO <- ifelse(income < 30000, 1350, ifelse(income < 63750, 1350 - 0.04 * (income - 30000), 0))
    tax <- ifelse(income < input$bracket_1, 0, ifelse(income < input$bracket_2, 
                                                      txmr(input$bracket_1) * (income - input$bracket_1), # from 0.19
                                                      ifelse(income < input$bracket_3, 
                                                             txamt(input$bracket_2) + txmr(input$bracket_2) * (income - input$bracket_2), # from 0.325
                                                             ifelse(income < input$bracket_4,
                                                                    txamt(input$bracket_3) + txmr(input$bracket_3) * (income - input$bracket_3), # from 0.37
                                                                    txamt(input$bracket_4) + txmr(input$bracket_4) * (income - input$bracket_4)))))
    medicare.levy <- ifelse(income < 18840, 0, ifelse(income < 22164, 0.1 * (income - 18840), 0.015 * income))
    out <- pmax(tax + medicare.levy - LITO, 0)
    out
  }
  return(new_income_tax(income0910))
}
      
```

```{r}
hes10_indiv %<>%
  mutate(
    old_tax = 52 * Imputed_current_weekly_tax_payable,
    new_tax = new_income_tax_outer0910(taxable_income, rates = c(0, 0.13, 0.29, 0.38, 0.45)),
    tax_diff = pmax(0, old_tax - new_tax)
      ) 

new_tax_by_indiv <- 
  hes10_indiv %>%
  select(Unique_household_number, 
         tax_diff) %>%
  group_by(Unique_household_number) %>%
  summarise(tax_diff = sum(tax_diff))
  
```

GST compensation with welfare
```{r}
hes_with_gst_compensation %T>%
  chart_data() %>%
  grplot(aes(fill = income_quintile, x = threshold, y = comp_adequacy)) + 
  geom_bar(stat = "identity",
           position = "dodge") + 
  scale_y_continuous("Percent reaching threshold", label=percent,
                     expand = c(0,0),
                     limits = c(0,1)) + 
  guides(fill = guide_legend("Quintiles",
                             direction = "horizontal",
                             label.position = "top",
                             label.hjust = 0.5
                             )) + 
  xlab("Compensation relative to increased burden") + 
  theme(legend.position = c(0.7,0.8),
        axis.title.y = element_text(angle = 90))
  
```

GST compensation with welfare and tax cuts

```{r}
hes_with_gst_and_tax_compensation <- 
  hes10hh %>%
  group_by.income_quintile() %>%
  ungroup %>%
  data.table %>%
  setkey(income_quintile) %>%
  merge(., welfare.by.income.quintile_total) %>%
  group_by(income_quintile) %>%
  mutate(
    new_welfare = gst_revenue.15pc.weekly * percentage_of_revenue_to_transfers *
      prop_welfare / # amount to all households in that quintile
      sum(Weight_HH_HES)
  ) %>%
  merge(new_tax_by_indiv, by = "Unique_household_number") %>%
  mutate(tax_diff_weekly = tax_diff / 52) %>% 
  group_by(income_quintile) %>%
  summarise(comp_adequacy.75pc = weighted.mean(new_welfare + tax_diff_weekly > 0.75* Weekly_household_GST_on_all_goods_and_services_FIS/2, Weight_HH_HES),
            comp_adequacy.100pc = weighted.mean(new_welfare + tax_diff_weekly > Weekly_household_GST_on_all_goods_and_services_FIS/2, Weight_HH_HES),
            comp_adequacy.125pc = weighted.mean(new_welfare + tax_diff_weekly > 1.25*Weekly_household_GST_on_all_goods_and_services_FIS/2, Weight_HH_HES)
  )

hes_with_gst_and_tax_compensation %>%
  gather(threshold, comp_adequacy, comp_adequacy.75pc:comp_adequacy.125pc) %>%
  mutate(threshold = gsub("pc", "%", 
                        gsub("^.*\\.", "", threshold)),
         threshold = factor(threshold, levels = c("75%", "100%", "125%"))) %>%
  grplot(aes(fill = income_quintile, x = threshold, y = comp_adequacy)) + 
  geom_bar(stat = "identity",
           position = "dodge") + 
  scale_y_continuous("Percent reaching threshold", label=percent,
                     expand = c(0,0),
                     limits = c(0,1)) + 
  guides(fill = guide_legend("Quintiles",
                             direction = "horizontal",
                             label.position = "top",
                             label.hjust = 0.5
                             )) + 
  theme(legend.position = c(0.7,0.8),
        axis.title.y = element_text(angle = 90))

```


# hes10hh %>%
#   group_by.income_quintile() %>%
#   ungroup %>%
#   data.table %>%
#   setkey(income_quintile) %>%
#   merge(., welfare.by.income.quintile_total) %>%
#   group_by(income_quintile) %>%
#   mutate(
#     new_welfare = gst_revenue.15pc.weekly * percentage_of_revenue_to_transfers *
#       prop_welfare / # amount to all households in that quintile
#       sum(Weight_HH_HES)
#   ) %>% as.data.table()
```


---
title: "What to do with $43bn?"
author: "Hugh Parsonage"
date: "4 September 2015"
output: html_document
runtime: shiny
---

```{r, results='hide', echo=FALSE}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      echo=FALSE,
                      fig.height=8, fig.width=13)
```

```{r}
library(knitr)
library(shiny)
library(ggplot2)
library(scales)
library(grattan)
library(VIM) # VIM::hotdeck used for imputation
library(dplyr)
library(data.table)
library(readxl)
library(readr)
library(tidyr)
library(magrittr)
library(rsdmx)
```

## Change the marginal tax rates
```{r}
shinyApp( options = list(height = 1024),
  ui = sidebarLayout(
    fluid = FALSE,
    sidebarPanel = sidebarPanel(
      selectInput("TargetFY", label = "Inflate values to", selected = "2012-13",
                  choices = c("2012-13", "2013-14")),
      textInput("cameo1", label = "Cameo 1 total income", value = 0),
      textInput("cameo2", label = "Cameo 2 total income", value = 0),
      sliderInput("rate_1", label = "marginal rate",
                  min = 0, max = 0.6, value = 0, step = 0.005),
      sliderInput("bracket_1", label = "bracket",
                  min = 0, max = 250e3, value = 18200, step = 100),
      sliderInput("rate_2", label = "marginal rate",
                  min = 0, max = 0.6, value = 0.19, step = 0.005),
      sliderInput("bracket_2", label = " bracket",
                  min = 0, max = 250e3, value = 37000, step = 100),
      sliderInput("rate_3", label = "marginal rate",
                  min = 0, max = 0.6, value = 0.325, step = 0.005),
      sliderInput("bracket_3", label = "bracket",
                  min = 0, max = 250e3, value = 80000, step = 100),
      sliderInput("rate_4", label = "marginal rate",
                  min = 0, max = 0.6, value = 0.37, step = 0.005),
      sliderInput("bracket_4", label = "bracket",
                  min = 0, max = 250e3, value = 180000, step = 100),
      sliderInput("rate_5", label = "marginal rate",
                  min = 0, max = 0.6, value = 0.45, step = 0.005)
    ),
    mainPanel(
      tableOutput("values"),
      plotOutput("chart")
    )
  )
  ,
  #####################################
  #####################################
  #               SERVER              #
  #####################################
  #####################################
  server = function(input, output) {
    sliderValues <- reactive({
      
      # The heavy lifting begins here.
      tax_rates <- 
        data.table(
          brackets = c(0, input$bracket_1, input$bracket_2, input$bracket_3, input$bracket_4),
          rates = c(input$rate_1, 
                    input$rate_2,
                    input$rate_3,
                    input$rate_4,
                    input$rate_5)
        ) %>%
        mutate(
          tax_amount = NA_real_
        )
      
      for (i in 1:nrow(tax_rates)){
        if (i == 1 || i == 2) {
          tax_rates$tax_amount <- 0
        } else {
          tax_rates$tax_amount[i] <-
            tax_rates$tax_amount[i - 1] + 
            tax_rates$rates[i - 1] * (tax_rates$brackets[i] - tax_rates$brackets[i - 1]) 
        }
        
      }
      
      txamt <- function(bracket.lwr){
        tax_rates %>%
          filter(brackets == bracket.lwr) %$%
          tax_amount
      }
      
      txmr <- function(bracket.lwr){
        tax_rates %>% 
          filter(brackets == bracket.lwr) %$%
          rates
      }
      
      new_income_tax <- function(income){
        ML.lower <- 20542
        ML.upper <- 24167
        medicare.base.rate <- 0.015
        LITO <- ifelse(income < input$bracket_2, 445, ifelse(income < 66667, 
                                                   445 - ((income - input$bracket_2) * 0.015), 0))
        tax <- ifelse(income < input$bracket_1, 0, ifelse(income < input$bracket_2, 
                                                txmr(input$bracket_1) * (income - input$bracket_1), # from 0.19
                                                ifelse(income < input$bracket_3, 
                                                       txamt(input$bracket_2) + txmr(input$bracket_2) * (income - input$bracket_2), # from 0.325
                                                       ifelse(income < input$bracket_4,
                                                              txamt(input$bracket_3) + txmr(input$bracket_3) * (income - input$bracket_3), # from 0.37
                                                              txamt(input$bracket_4) + txmr(input$bracket_4) * (income - input$bracket_4)))))
        medicare.levy <- ifelse(income <= ML.lower, 0, ifelse(income > ML.lower & income <= ML.upper, 
                                                              0.1 * (income - 20542), 
                                                              0.015 * income))
        out <- pmax(tax + medicare.levy - LITO, 0)
        return(out)
      }
      
      fread("Just_Taxable_Income.csv") %>% 
        mutate(diff = income_tax(Taxable_Income) - new_income_tax(Taxable_Income),
               diff = cpi_inflator(diff, from_fy = "2012-13", to_fy = input$TargetFY)) %$% 
        {-1 * sum(diff)*50} %>%
        grattan_dollar(.) ->
        the_amount_remaining
      
      # lm(Taxable_Income ~ Tot_inc_amt, data = get_sample_file(2013)) %>% coef %>% extract2(2)
      cameo1.Taxable_Income <- 0.96 * as.numeric(input$cameo1)
      cameo2.Taxable_Income <- 0.96 * as.numeric(input$cameo2)
      
      fread("Just_Taxable_Income.csv") %$% 
        {income_tax(as.numeric(cameo1.Taxable_Income)) - new_income_tax(as.numeric(cameo1.Taxable_Income))} ->
        cameo1_diff
      
      fread("Just_Taxable_Income.csv") %$% 
        {income_tax(as.numeric(cameo2.Taxable_Income)) - new_income_tax(as.numeric(cameo2.Taxable_Income))} ->
        cameo2_diff
      
      # Reactive expression to compose a data frame containing all of
      # the values
      
      
      # Compose data frame
      brackets <- 
        paste0(paste0("$", prettyNum(c(0, input$bracket_1, input$bracket_2, input$bracket_3), big.mark = ",")),
               "-",
               paste0("$", prettyNum(c(input$bracket_1, input$bracket_2, input$bracket_3, input$bracket_4), big.mark = ","))
        )
      
      data.frame(
        `Marginal rate of` = c(brackets,
                               "",
                          "Extra revenue", 
                          "$100,000",
                          paste("Cameo 1 saving", input$cameo1),
                          paste("Cameo 2 saving", input$cameo2)),
        Value = as.character(c(input$rate_1, 
                               input$rate_2,
                               input$rate_3,
                               input$rate_4,
                               input$rate_5,
                               the_amount_remaining,
                               grattan_dollar(new_income_tax(cpi_inflator(100e3, from_fy = "2012-13", to_fy = "2013-14"))),
                               grattan_dollar(cameo1_diff),
                               grattan_dollar(cameo2_diff))), 
        stringsAsFactors=FALSE) 
      }) 
    
    chartValues <- reactive({
            tax_rates <- 
        data.table(
          brackets = c(0, input$bracket_1, input$bracket_2, input$bracket_3, input$bracket_4),
          rates = c(input$rate_1, 
                    input$rate_2,
                    input$rate_3,
                    input$rate_4,
                    input$rate_5)
        ) %>%
        mutate(
          tax_amount = NA_real_
        )
      
      for (i in 1:nrow(tax_rates)){
        if (i == 1 || i == 2) {
          tax_rates$tax_amount <- 0
        } else {
          tax_rates$tax_amount[i] <-
            tax_rates$tax_amount[i - 1] + 
            tax_rates$rates[i - 1] * (tax_rates$brackets[i] - tax_rates$brackets[i - 1]) 
        }
        
      }
      
      txamt <- function(bracket.lwr){
        tax_rates %>%
          filter(brackets == bracket.lwr) %$%
          tax_amount
      }
      
      txmr <- function(bracket.lwr){
        tax_rates %>% 
          filter(brackets == bracket.lwr) %$%
          rates
      }
      
      new_income_tax <- function(income){
        ML.lower <- 20542
        ML.upper <- 24167
        medicare.base.rate <- 0.015
        LITO <- ifelse(income < input$bracket_2, 445, ifelse(income < 66667, 
                                                   445 - ((income - input$bracket_2) * 0.015), 0))
        tax <- ifelse(income < input$bracket_1, 0, ifelse(income < input$bracket_2, 
                                                txmr(input$bracket_1) * (income - input$bracket_1), # from 0.19
                                                ifelse(income < input$bracket_3, 
                                                       txamt(input$bracket_2) + txmr(input$bracket_2) * (income - input$bracket_2), # from 0.325
                                                       ifelse(income < input$bracket_4,
                                                              txamt(input$bracket_3) + txmr(input$bracket_3) * (income - input$bracket_3), # from 0.37
                                                              txamt(input$bracket_4) + txmr(input$bracket_4) * (income - input$bracket_4)))))
        medicare.levy <- ifelse(income <= ML.lower, 0, ifelse(income > ML.lower & income <= ML.upper, 
                                                              0.1 * (income - 20542), 
                                                              0.015 * income))
        out <- pmax(tax + medicare.levy - LITO, 0)
        return(out)
      }
      
      p <- data.table(
          Taxable_Income = 10*(1:25000)
        ) %>%
          mutate(
            marginal.tax = income_tax(Taxable_Income + 1) - income_tax(Taxable_Income),
            new.marginal.tax = new_income_tax(Taxable_Income + 1) - new_income_tax(Taxable_Income)
          ) %>%
          gather(new_or_old, marginal.rate, marginal.tax,new.marginal.tax) %>%
          mutate(new_or_old = ifelse(new_or_old == "marginal.tax", "New", "Old")) %>%
          grplot(aes(x = Taxable_Income, y = marginal.rate, 
                     group = new_or_old, color = new_or_old, label = new_or_old)) + 
          geom_line() + 
          scale_x_continuous(limits = c(0,2.5e5), label=grattan_dollar) + 
          scale_y_continuous(label=percent) + 
          annotate("text",
                   label = "Old rate",
                   size = 7.14,
                   fontface = "bold",
                   color = gpal(2)[1],
                   x = 50e3,
                   y = 0.38, 
                   vjust = 1) +
          annotate("text", 
                   label = "New rate",
                   size = 7.14,
                   fontface = "bold",
                   color = gpal(2)[2],
                   x = 88e3,
                   y = 0.205,
                   vjust = 0,
                   hjust = 0)
        print(p)
    })
      
      # Show the values using an HTML table
      output$values <- renderTable(
        expr = sliderValues(),
        align = "llr",
        include.rownames = FALSE
      )
      
      
      output$chart <- renderPlot({
        expr = chartValues()
      })
    }
    
)
```

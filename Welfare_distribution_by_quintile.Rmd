---
title: "Welfare component by household quintile"
author: "Hugh Parsonage"
date: "15 September 2015"
output: html_document
---

```{r, results='hide'}
knitr::opts_chunk$set(warning = FALSE,
                      message = FALSE, 
                      fig.height=15, fig.width=20)
```

```{r}
library(ggplot2)
library(grattan)
library(VIM) # VIM::hotdeck used for imputation
library(dplyr)
library(foreign)
library(survey)
library(data.table)
library(readxl)
library(readr)
library(tidyr)
library(magrittr)
library(httr)
```

# Variable preparation
```{r}
hes.sih.vars <- read_excel("./SIH/HES_and_SIH_variable_listing.xlsx") 

# See page 21 of HES 2009-10 user guide
# http://www.ausstats.abs.gov.au/ausstats/subscriber.nsf/0/1D03ACBBD40275ADCA257A3900173E85/$File/65030_1.pdf
hes.sih.vars %<>%
  mutate(Definition = ifelse(HES_basic_name == "COICEXP", paste0(Definition, "_COICOP"), Definition))

hes.sih.vars %<>%
  gather(GROUP, variable, -Definition) %>%
  mutate(variable = gsub("[^A-Za-z0-9]", "", variable)) %>%
  filter(complete.cases(.)) %>%
  spread(GROUP, variable) %>%
  mutate(
    # replace all nonletters with _ unless they occur at the end of the name,
    # in which case delete it
    Definition_new = gsub("[^A-Za-z]+(?!$)", "_", Definition, perl = TRUE),
    Definition_new = gsub("[^A-Za-z]+$", "", Definition_new)
  )
```

# HES data input

```{r}
hes10hh_raw <- read.dta("./HES/hes10bh.dta")

hes10_indiv_raw <- 
  read.dta("./HES/hes10bp.dta")

hes10hp.names <- 
  hes.sih.vars$HES_basic_name[hes.sih.vars$HES_basic_name %in% names(hes10_indiv_raw)]
hes10hp.newnames <-
  hes.sih.vars$Definition_new[hes.sih.vars$HES_basic_name %in% names(hes10_indiv_raw)]

hes10_indiv <- 
  hes10_indiv_raw %>%
  data.table %>%
  select_(.dots = hes10hp.names) %>%
  setnames(old = hes10hp.names, 
           new = hes10hp.newnames)

```


```{r}
hes10hh.names <- 
  hes.sih.vars$HES_basic_name[hes.sih.vars$HES_basic_name %in% names(hes10hh_raw)]
hes10hh.newnames <-
  hes.sih.vars$Definition_new[hes.sih.vars$HES_basic_name %in% names(hes10hh_raw)]

hes10hh <-
  hes10hh_raw %>%
  # This omits some weights and PETTAX (hh consumption of fuel tax) for some reason
  select_(.dots = hes10hh.names) %>%
  data.table %>%
  setnames(old = hes10hh.names, 
           new = hes10hh.newnames)
```


```{r}
total.inc.quintiles <- 
  hes10hh %>%
  svydesign(~Unique_household_number, data = ., weights = ~Weight_HH_HES) %>%
  svyquantile(~Total_current_weekly_HH_income_from_all_sources 
              ,.
              #, quantiles = c(0:5)/5)
              ,quantiles = c(0:5)/5)
```



```{r, echo=FALSE}
```{r}
welfare.by.income.quintile <- 
  hes10_indiv %>%
  merge(hes10hh, by = "Unique_household_number", suffixes = c("indiv", "hh")) %>%
  mutate(Gross_income_quintile = factor(as.numeric(cut(Total_current_weekly_HH_income_from_all_sources, 
                                                       breaks = total.inc.quintiles,  
                                                       include.lowest = TRUE)))) %>%
  select(Unique_household_number, Gross_income_quintile, 
         Weight_Person_HES, 
         Current_weekly_amount_of_Commonwealth_Rent_Assistance, Current_weekly_income_from_age_pension, Current_weekly_income_from_wife_pension, Current_weekly_income_from_carer_payment, 
         Current_weekly_income_from_carer_allowance, Current_weekly_income_from_special_benefit, Current_weekly_income_from_widow_allowance, Current_weekly_income_from_youth_allowance, Current_weekly_income_from_Austudy_Abstudy, Current_weekly_income_from_parenting_payment, Current_weekly_income_from_Baby_Bonus_payment, Current_weekly_income_from_partner_allowance, Current_weekly_income_from_senior_supplement, Current_weekly_income_from_newstart_allowance, Current_weekly_income_from_pension_supplement, Current_weekly_income_from_sickness_allowance, Current_weekly_income_from_service_pension_DVA, Current_weekly_income_from_utilities_allowance, Current_weekly_income_from_disability_pension_DVA, Current_weekly_income_from_war_widows_pension_DVA, Current_weekly_income_from_disability_support_pension, Current_weekly_income_from_family_tax_benefits_modelled, Current_weekly_income_from_other_government_pensions_and_allowances) %>%
  gather(Allowance, income, -Unique_household_number, -Gross_income_quintile, -Weight_Person_HES) %>%
  data.table %>%
  mutate(Allowance = gsub("Current_weekly_income_from_", "", Allowance, fixed = TRUE)) %>%
  group_by(Gross_income_quintile, Allowance) %>%
  summarise(total = sum(income * Weight_Person_HES)) %>%
  ungroup %>% 
  arrange(desc(total)) 


welfare.by.income.quintile %>%
  mutate(Allowance = factor(Allowance, levels = (welfare.by.income.quintile$Allowance), ordered = TRUE)) %>%
  mutate(text = ifelse(Gross_income_quintile == 2 & total > 1e7, gsub("_", " ", Allowance, fixed = TRUE), NA_character_)) %>%
  group_by(Gross_income_quintile) %>%
  arrange(desc(total)) %>%
  mutate(text.y = cumsum(total)) %>%
  ggplot(aes(x = Gross_income_quintile, fill = Allowance, order = Allowance)) + 
  geom_bar(aes(y = total), stat = "identity", position = "stack") + 
  geom_text(aes(label = text, y = text.y), vjust = 1, fontface = "bold", size = 5.5) + 
  scale_fill_manual(values = c(rep(RColorBrewer::brewer.pal(11, name="Spectral"), 2), "black")) + 
  theme_light(base_size = 18)
```


